/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var gt=Object.defineProperty;var Ct=Object.getOwnPropertyDescriptor;var kt=Object.getOwnPropertyNames;var Lt=Object.prototype.hasOwnProperty;var Ft=(V,Y)=>{for(var e in Y)gt(V,e,{get:Y[e],enumerable:!0})},Dt=(V,Y,e,i)=>{if(Y&&typeof Y=="object"||typeof Y=="function")for(let t of kt(Y))!Lt.call(V,t)&&t!==e&&gt(V,t,{get:()=>Y[t],enumerable:!(i=Ct(Y,t))||i.enumerable});return V};var $t=V=>Dt(gt({},"__esModule",{value:!0}),V);var Mt={};Ft(Mt,{default:()=>ht});module.exports=$t(Mt);var h=require("obsidian"),dt="brainstall-view",rt=class extends h.FuzzySuggestModal{constructor(e,i,t){super(e);this.items=i,this.onChooseCallback=t}getItems(){return this.items}getItemText(e){return e.basename}onChooseItem(e,i){this.onChooseCallback(e)}},Pt={openai:[{id:"o1",name:"o1"},{id:"o1-preview",name:"o1-preview"},{id:"o1-mini",name:"o1-mini"},{id:"gpt-4o",name:"gpt-4o"},{id:"gpt-4o-mini",name:"gpt-4o-mini"},{id:"gpt-4.5-preview",name:"gpt-4.5-preview"},{id:"gpt-4.1",name:"gpt-4.1"},{id:"gpt-4.1-nano",name:"gpt-4.1-nano"},{id:"gpt-4.1-mini",name:"gpt-4.1-mini"},{id:"gpt-5",name:"gpt-5"},{id:"gpt-5-mini",name:"gpt-5-mini"},{id:"gpt-4-turbo",name:"gpt-4-turbo"},{id:"gpt-4",name:"gpt-4"},{id:"gpt-3.5-turbo",name:"gpt-3.5-turbo"}],groq:[{id:"qwen/qwen3-32b",name:"qwen3-32b"},{id:"llama-3.1-8b-instant",name:"llama-3.1-8b"},{id:"llama-3.3-70b-versatile",name:"llama-3.3-70b"},{id:"meta-llama/llama-4-scout-17b-16e-instruct",name:"llama-4-scout-17b"},{id:"meta-llama/llama-4-maverick-17b-128e-instruct",name:"llama-4-maverick-17b"},{id:"qwen-qwq-32b",name:"qwen-qwq-32b"}],claude:[{id:"claude-3-7-sonnet-20250219",name:"claude-3-7-sonnet"},{id:"claude-3-sonnet-20240229",name:"claude-3-sonnet"},{id:"claude-3-opus-latest",name:"claude-3-opus"},{id:"claude-3-haiku-20240307",name:"claude-3-haiku"},{id:"claude-3-5-sonnet-latest",name:"claude-3-5-sonnet"},{id:"claude-3-5-haiku-latest",name:"claude-3-5-haiku"},{id:"claude-sonnet-4-20250514",name:"claude-sonnet-4"},{id:"claude-haiku-4-5-20251001",name:"claude-haiku-4.5"},{id:"claude-opus-4-20250514",name:"claude-opus-4"},{id:"claude-opus-4-1-20250805",name:"claude-opus-4.1"}]},At={notificationFolder:"Archives/Notifications",provider:"openai",openaiApiKey:"",claudeApiKey:"",groqApiKey:"",model:"gpt-4o-mini",analysisFolder:"Topics",timestampFormat:"YYYYMMDD_HHmmss"},mt=class extends h.ItemView{constructor(e,i){super(e);this.plugin=i;this.showArchived=!1;this.searchKeyword="";this.searchDate="";this.searchType="";this.selectedPriorities=[];this.saveListeners=[];this.isInputVisible=!1;this.floatingButton=null;this.inputOverlay=null;this.inputResizeHandler=null;this.inputViewportHandler=null;this.activeFileDisplay=null;this.selectedFile=void 0;this.clearFileBtn=null;this.fileDisplayContent=null;this.deepDiveButton=null}getViewType(){return dt}getDisplayText(){return"Brainstall"}getIcon(){return"brain"}async onOpen(){let e=this.containerEl.children[1];e.empty(),this.notificationSectionContainer=e.createEl("div",{cls:"notification-section"}),this.inputContainer=this.notificationSectionContainer.createEl("div",{cls:"brainstall-input-section"}),this.inputContainer.addClass("hidden"),this.activeFileDisplay=this.inputContainer.createEl("div",{cls:"brainstall-active-file-display"}),this.activeFileDisplay.style.cursor="pointer",this.activeFileDisplay.style.display="flex",this.activeFileDisplay.style.alignItems="center",this.activeFileDisplay.style.overflow="hidden",this.activeFileDisplay.style.padding="8px 30px 8px 12px",this.activeFileDisplay.setAttribute("title","\u30AF\u30EA\u30C3\u30AF\u3057\u3066\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E"),this.fileDisplayContent=this.activeFileDisplay.createEl("span",{cls:"brainstall-active-file-content"}),this.fileDisplayContent.style.flex="1",this.fileDisplayContent.style.minWidth="0",this.fileDisplayContent.style.maxWidth="calc(100% - 32px)",this.fileDisplayContent.style.overflow="hidden",this.fileDisplayContent.style.textOverflow="ellipsis",this.fileDisplayContent.style.whiteSpace="nowrap",this.clearFileBtn=this.activeFileDisplay.createEl("button",{cls:"brainstall-clear-file-btn"}),this.clearFileBtn.textContent="\xD7",this.clearFileBtn.setAttribute("title","\u9078\u629E\u3092\u30AF\u30EA\u30A2"),this.clearFileBtn.addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),this.selectedFile=null,this.updateActiveFileDisplay()}),this.activeFileDisplay.addEventListener("click",v=>{if(v.target.closest(".brainstall-clear-file-btn"))return;let u=this.app.vault.getMarkdownFiles();new rt(this.app,u,f=>{this.selectedFile=f,this.updateActiveFileDisplay(),this.referenceContainer&&!this.referenceContainer.hasClass("hidden")&&this.updateReference()}).open()}),this.app.workspace.on("active-leaf-change",()=>{this.selectedFile===void 0&&(this.updateActiveFileDisplay(),this.referenceContainer&&!this.referenceContainer.hasClass("hidden")&&this.updateReference())}),this.updateActiveFileDisplay();let i=this.inputContainer.createEl("div",{cls:"brainstall-textarea-wrapper"}),t=i.createEl("textarea",{cls:"brainstall-input"});t.rows=5,t.placeholder=`\u30BF\u30A4\u30C8\u30EB
\u6982\u8981
#\u30AD\u30FC\u30EF\u30FC\u30C9`,t.setAttribute("readonly","readonly"),t.addEventListener("focus",()=>{setTimeout(()=>{t.removeAttribute("readonly")},0)}),i.createEl("button",{cls:"brainstall-input-close-btn",text:"\u2715",attr:{title:"\u9589\u3058\u308B"}}).addEventListener("click",()=>{this.toggleInputSection()});let r=this.inputContainer.createEl("div",{cls:"brainstall-input-buttons"}),n=r.createEl("button",{text:"\u{1F4DD} \u30E1\u30E2",cls:"brainstall-submit-btn"});n.disabled=!0,n.addEventListener("click",()=>{let v=t.value,u=this.selectedFile||this.app.workspace.getActiveFile();this.handleSubmitContent(v,u),t.value="",l()});let a=r.createEl("button",{text:"\u{1F4CB} \u30EA\u30B9\u30C8\u5316",cls:"brainstall-listify-btn mod-cta"});a.disabled=!0,this.deepDiveButton=r.createEl("button",{text:"\u{1F50D} \u6DF1\u6398\u308A",cls:"brainstall-deep-dive-btn mod-cta"}),this.deepDiveButton.disabled=!0;let l=()=>{let v=t.value.trim().length>0;n.disabled=!v,a.disabled=!v,this.deepDiveButton&&(this.deepDiveButton.disabled=!v)};t.addEventListener("input",l);let y="";t.addEventListener("input",v=>{var q;let u=v.target,m=u.value,f=u.selectionStart,L=m.substring(0,f),K=m.length>y.length||v.inputType==="insertText"||v.inputType==="insertCompositionText"||!v.inputType;if(L.endsWith("[[")&&K){let $=f-2,lt=u.value.substring(0,$),ot=u.value.substring(f);u.value=lt+"[[]]"+ot,u.selectionStart=$+2,u.selectionEnd=$+2;let d=this.app.vault.getMarkdownFiles(),c=!1,S=new rt(this.app,d,H=>{c=!0;let R=u.value.substring(0,$),U=u.value.substring($+4),X=`[[${H.basename}]]`;u.value=R+X+U;let ct=$+X.length;u.selectionStart=ct,u.selectionEnd=ct,l(),u.focus()}),M=(q=S.onClose)==null?void 0:q.bind(S);M&&(S.onClose=()=>{M(),c||(u.selectionStart=$+2,u.selectionEnd=$+2,u.focus())}),S.open()}y=m}),a.addEventListener("click",async()=>{let v=t.value;if(!v.trim()){new h.Notice("\u30C6\u30AD\u30B9\u30C8\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}if(!this.checkApiKey())return;t.value="",l();let u=new h.Notice(`\u{1F4CB} \u30EA\u30B9\u30C8\u5316\u51E6\u7406\u4E2D: \u300C${v}\u300D`,0),m=`skeleton-${Date.now()}-${Math.random()}`,f=null,L=this.postsContainer.querySelector(".brainstall-posts-list");if(L||(L=this.postsContainer.createEl("div",{cls:"brainstall-posts-list"})),L){f=L.createEl("div",{cls:"brainstall-post skeleton"}),f.setAttribute("data-skeleton-id",m),f.createEl("div",{text:"\u{1F4CB} \u30EA\u30B9\u30C8\u5316\u51E6\u7406\u4E2D",cls:"brainstall-post-date"}),f.createEl("div",{text:`\u300C${v}\u300D\u306E\u30C1\u30A7\u30C3\u30AF\u30EA\u30B9\u30C8\u3092\u4F5C\u6210\u4E2D...`,cls:"brainstall-post-content"});for(let K=0;K<3;K++){let q=f.createEl("div",{cls:"brainstall-skeleton-line"});q.style.width=`${80-K*10}%`}L.insertBefore(f,L.firstChild)}try{if(await this.handleListifyContent(v))f&&f.parentNode&&f.remove(),await this.updatePosts(),u.hide(),new h.Notice(`\u2705 \u30EA\u30B9\u30C8\u5316\u5B8C\u4E86: \u300C${v}\u300D`);else{let q=this.postsContainer.querySelector(".brainstall-posts-list"),$=q==null?void 0:q.querySelector(`[data-skeleton-id="${m}"]`);$==null||$.remove(),u.hide(),new h.Notice("\u274C \u30EA\u30B9\u30C8\u5316\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}}catch(K){let q=this.postsContainer.querySelector(".brainstall-posts-list"),$=q==null?void 0:q.querySelector(`[data-skeleton-id="${m}"]`);$==null||$.remove(),u.hide(),console.error("Listify error:",K),new h.Notice("\u274C \u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F")}}),this.deepDiveButton.addEventListener("click",async()=>{let v=t.value;if(!v.trim()){new h.Notice("\u30C6\u30AD\u30B9\u30C8\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}if(!this.checkApiKey()||!this.deepDiveButton)return;t.value="",l();let u=new h.Notice(`\u{1F50D} \u6DF1\u6398\u308A\u51E6\u7406\u4E2D: \u300C${v}\u300D`,0),m=`skeleton-${Date.now()}-${Math.random()}`,f=null,L=this.postsContainer.querySelector(".brainstall-posts-list");if(L||(L=this.postsContainer.createEl("div",{cls:"brainstall-posts-list"})),L){f=L.createEl("div",{cls:"brainstall-post skeleton"}),f.setAttribute("data-skeleton-id",m),f.createEl("div",{text:"\u{1F50D} \u6DF1\u6398\u308A\u51E6\u7406\u4E2D",cls:"brainstall-post-date"}),f.createEl("div",{text:`\u300C${v}\u300D\u306B\u95A2\u3059\u308B\u8A18\u4E8B\u3092\u4F5C\u6210\u4E2D...`,cls:"brainstall-post-content"});for(let K=0;K<3;K++){let q=f.createEl("div",{cls:"brainstall-skeleton-line"});q.style.width=`${80-K*10}%`}L.insertBefore(f,L.firstChild)}try{let K=await this.handleDeepDiveContent(v);if(K&&K.content)f&&f.parentNode&&f.remove(),await this.saveDeepDiveArticle(v,K.title,K.content),await this.updatePosts(),u.hide(),new h.Notice(`\u2705 \u6DF1\u6398\u308A\u5B8C\u4E86: \u300C${v}\u300D`);else{let q=this.postsContainer.querySelector(".brainstall-posts-list"),$=q==null?void 0:q.querySelector(`[data-skeleton-id="${m}"]`);$==null||$.remove(),u.hide(),new h.Notice("\u274C \u6DF1\u6398\u308A\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}}catch(K){let q=this.postsContainer.querySelector(".brainstall-posts-list"),$=q==null?void 0:q.querySelector(`[data-skeleton-id="${m}"]`);$==null||$.remove(),u.hide(),console.error("DeepDive error:",K),new h.Notice("\u274C \u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F")}});let g=this.notificationSectionContainer.createEl("div",{cls:"brainstall-content"});this.contentContainer=g,this.postsContainer=g.createEl("div",{cls:"brainstall-posts active"}),this.statsContainer=g.createEl("div",{cls:"brainstall-stats hidden"}),this.grassContainer=this.statsContainer.createEl("div",{cls:"brainstall-grass"}),this.referenceContainer=g.createEl("div",{cls:"brainstall-reference hidden"});let A=this.notificationSectionContainer.createEl("div",{cls:"brainstall-tabs"}),E=A.createEl("button",{cls:"brainstall-tab active",attr:{"data-tab":"posts"}}),W=E.createEl("span",{text:"\u{1F4EC}",cls:"brainstall-tab-icon"}),w=E.createEl("span",{text:"\u53D7\u4FE1\u7BB1",cls:"brainstall-tab-label"}),b=A.createEl("button",{cls:"brainstall-tab",attr:{"data-tab":"stats"}}),D=b.createEl("span",{text:"\u{1F4CA}",cls:"brainstall-tab-icon"}),I=b.createEl("span",{text:"\u7D71\u8A08",cls:"brainstall-tab-label"}),B=A.createEl("button",{cls:"brainstall-tab",attr:{"data-tab":"reference"}}),T=B.createEl("span",{text:"\u{1F517}",cls:"brainstall-tab-icon"}),k=B.createEl("span",{text:"\u53C2\u7167",cls:"brainstall-tab-label"});E.addEventListener("click",()=>this.switchTab("posts")),b.addEventListener("click",()=>this.switchTab("stats")),B.addEventListener("click",()=>this.switchTab("reference")),this.floatingButton=e.createEl("button",{cls:"brainstall-floating-button",text:"\u270F\uFE0F",attr:{title:"\u5165\u529B\u6B04\u3092\u958B\u304F"}}),this.floatingButton.addEventListener("click",()=>{this.toggleInputSection()}),this.inputOverlay=e.createEl("div",{cls:"brainstall-input-overlay hidden"}),this.inputOverlay.style.pointerEvents="none",await this.updatePosts(),await this.updateStats()}updateActiveFileDisplay(){if(!this.fileDisplayContent)return;let e=null;this.selectedFile!==void 0?e=this.selectedFile:e=this.app.workspace.getActiveFile(),e?(this.fileDisplayContent.textContent=`\u{1F4C4} ${e.basename}`,this.clearFileBtn&&(this.clearFileBtn.style.display="flex")):(this.fileDisplayContent.textContent="\u{1F4C4} \u30EA\u30F3\u30AF\u5143\u30D5\u30A1\u30A4\u30EB\u304C\u9078\u629E\u3055\u308C\u3066\u3044\u307E\u305B\u3093",this.clearFileBtn&&(this.clearFileBtn.style.display="none")),this.activeFileDisplay.style.display="block",this.referenceContainer&&!this.referenceContainer.hasClass("hidden")&&this.updateReference()}toggleInputSection(){var e,i;if(this.isInputVisible=!this.isInputVisible,this.isInputVisible){this.updateActiveFileDisplay();let t=(e=this.postsContainer)==null?void 0:e.querySelector(".brainstall-posts-list"),s=t?t.scrollTop:0;this.inputContainer.removeClass("hidden"),this.inputContainer.addClass("visible"),this.floatingButton&&this.floatingButton.addClass("hidden"),this.inputOverlay&&this.inputOverlay.removeClass("hidden");let r=()=>{var A;if(!this.isInputVisible||this.inputContainer.hasClass("hidden"))return;let a=this.inputContainer.getBoundingClientRect(),y=a.height+20,g=(A=this.postsContainer)==null?void 0:A.querySelector(".brainstall-posts-list");if(g){let E=g.scrollTop;g.style.setProperty("padding-bottom",`${y}px`,"important"),g.scrollTop=E}if(this.inputOverlay){let E=a.top;this.inputOverlay.style.height=`${E}px`,this.inputOverlay.style.top="auto",this.inputOverlay.style.bottom="0px"}};setTimeout(()=>{r(),t&&(t.scrollTop=s)},100);let n=this.inputContainer.querySelector("textarea");n&&(n.dispatchEvent(new Event("input",{bubbles:!0})),n.setAttribute("readonly","readonly"),setTimeout(()=>{n.focus(),setTimeout(()=>{n.removeAttribute("readonly"),t&&(t.scrollTop=s)},100)},100))}else{this.inputContainer.removeClass("visible"),this.inputContainer.addClass("hidden"),this.floatingButton&&this.floatingButton.removeClass("hidden"),this.inputOverlay&&(this.inputOverlay.addClass("hidden"),this.inputOverlay.style.top="",this.inputOverlay.style.bottom="",this.inputOverlay.style.height=""),this.inputResizeHandler&&(window.removeEventListener("resize",this.inputResizeHandler),this.inputResizeHandler=null),this.inputViewportHandler&&window.visualViewport&&(window.visualViewport.removeEventListener("resize",this.inputViewportHandler),window.visualViewport.removeEventListener("scroll",this.inputViewportHandler),this.inputViewportHandler=null);let t=(i=this.postsContainer)==null?void 0:i.querySelector(".brainstall-posts-list");t&&t.style.removeProperty("padding-bottom")}}async handleSubmitContent(e,i=null){if(!e.trim()){new h.Notice("\u5185\u5BB9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}await this.plugin.createNewPost(e,i),await this.updatePosts(),await this.updateGrass(),await this.updateStats(),new h.Notice("\u901A\u77E5\u3057\u307E\u3057\u305F\uFF01"),this.toggleInputSection()}async extractWikilinkContents(e){let i=/\[\[([^\]]+)\]\]/g,t=Array.from(e.matchAll(i));if(t.length===0)return"";let s=[];for(let r of t){let n=r[1],a=n.split("|").pop()||n,l=this.app.vault.getMarkdownFiles().find(y=>y.basename===a||y.name===a);if(l)try{let y=await this.app.vault.read(l);s.push(`

## [[${a}]]\u306E\u5185\u5BB9
${y}`)}catch(y){console.error(`Failed to read file ${a}:`,y)}}return s.join(`
`)}removeWikilinksForTitle(e){return e.replace(/\[\[([^\]]+)\]\]/g,(i,t)=>{let s=t.split("|");return s.length>1?s[s.length-1]:t})}removeWikilinkBrackets(e){return e.replace(/\[\[([^\]]+)\]\]/g,(i,t)=>{let s=t.split("|");return s.length>1?s[0]:t})}extractWikilinks(e){let i=/\[\[([^\]]+)\]\]/g,t=Array.from(e.matchAll(i)),s=[];for(let r of t){let n=r[1],a=n.split("|"),l=a.length>1?a[a.length-1]:n;this.app.vault.getMarkdownFiles().find(g=>g.basename===l||g.name===l)&&s.push(`[[${l}]]`)}return s}sanitizeContext(e){return e.replace(/[\/\\?%*:|"<>#\[\]]/g,"").replace(/\n+/g," ").replace(/\s+/g," ").trim()}checkApiKey(){let e=this.plugin.settings;switch(e.provider||"openai"){case"openai":if(!e.openaiApiKey||e.openaiApiKey.trim()==="")return new h.Notice("\u26A0\uFE0F OpenAI API\u30AD\u30FC\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u304B\u3089API\u30AD\u30FC\u3092\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),!1;break;case"claude":if(!e.claudeApiKey||e.claudeApiKey.trim()==="")return new h.Notice("\u26A0\uFE0F Claude API\u30AD\u30FC\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u304B\u3089API\u30AD\u30FC\u3092\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),!1;break;case"groq":if(!e.groqApiKey||e.groqApiKey.trim()==="")return new h.Notice("\u26A0\uFE0F Groq API\u30AD\u30FC\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u304B\u3089API\u30AD\u30FC\u3092\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),!1;break}return!0}async handleListifyContent(e){let i=this.plugin.settings,t=i.provider||"openai",s=i.model||"gpt-4o-mini",r=this.selectedFile||this.app.workspace.getActiveFile(),n="",a="";r&&(a=await this.app.vault.read(r),n=r.basename.replace(/\.md$/,""));let l=await this.extractWikilinkContents(e);l&&(a+=l);let y=this.removeWikilinksForTitle(n),g=await this.callLLMForListify(e,y,a,t,s);return g&&await this.saveListifyArticle(e,y,g),g}async handleDeepDiveContent(e){let i=this.plugin.settings,t=i.provider||"openai",s=i.model||"gpt-4o-mini",r=this.selectedFile||this.app.workspace.getActiveFile(),n="",a="";r&&(a=await this.app.vault.read(r),n=r.basename.replace(/\.md$/,""));let l=await this.extractWikilinkContents(e);if(l&&(a+=l),!a||a.trim().length===0)return new h.Notice("\u274C \u53C2\u7167\u30C6\u30AD\u30B9\u30C8\u304C\u4E0D\u8DB3\u3057\u3066\u3044\u307E\u3059\u3002\u30D5\u30A1\u30A4\u30EB\u3092\u958B\u3044\u3066\u304B\u3089\u6DF1\u6398\u308A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),null;let y=this.removeWikilinksForTitle(n),g=await this.callLLMForDeepDive(e,t,s,y,a);return{title:y,content:g}}formatTimestamp(e,i){let t=i.getFullYear(),s=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),n=String(i.getHours()).padStart(2,"0"),a=String(i.getMinutes()).padStart(2,"0"),l=String(i.getSeconds()).padStart(2,"0");return e==="ISO"?i.toISOString().replace(/[:.]/g,"-").slice(0,-5):e==="Unix"?String(Math.floor(i.getTime()/1e3)):e.replace(/YYYY/g,String(t)).replace(/MM/g,s).replace(/DD/g,r).replace(/HH/g,n).replace(/mm/g,a).replace(/ss/g,l)}toJSTISOString(e){let i=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0"),l=String(e.getMilliseconds()).padStart(3,"0");return`${i}-${t}-${s}T${r}:${n}:${a}.${l}+09:00`}getDateFolderPath(e,i){let t=i.getFullYear(),s=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),n=`${t}-${s}`,a=`${t}-${s}-${r}`;return`${e}/${t}/${n}/${a}`}async ensureFolderExists(e){if(!await this.app.vault.adapter.exists(e)){let i=e.split("/"),t="";for(let s of i)s!==""&&(t=t?`${t}/${s}`:s,await this.app.vault.adapter.exists(t)||await this.app.vault.createFolder(t))}}async saveDeepDiveArticle(e,i,t){let s=new Date,r=s.getFullYear(),n=String(s.getMonth()+1).padStart(2,"0"),a=String(s.getDate()).padStart(2,"0"),l=String(s.getHours()).padStart(2,"0"),y=String(s.getMinutes()).padStart(2,"0"),g=String(s.getSeconds()).padStart(2,"0"),A=this.formatTimestamp(this.plugin.settings.timestampFormat,s),E=e.split(`
`)[0]||"",w=this.removeWikilinkBrackets(E).replace(/[\/\\?%*:|"<>]/g,"_").replace(/\s+/g,"_").trim(),b=`${A}_deepDive_${w}.md`,D=this.plugin.settings.notificationFolder||"Archives/Notifications",I=this.getDateFolderPath(D,s);await this.ensureFolderExists(I);let B=[...this.extractWikilinks(e),...this.extractWikilinks(`[[${i}]]`)],T=Array.from(new Set(B)),k=this.sanitizeContext(this.removeWikilinkBrackets(E)),v=`---
type: deepDive`;if(k&&(v+=`
context: "${k}"`),T.length>0){v+=`
links:`;for(let m of T)v+=`
  - "${m}"`}v+=`
created: "${this.toJSTISOString(s)}"
---

${e}

---

${t}`;let u=`${I}/${b}`;await this.app.vault.create(u,v),await this.updateGrass(),await this.updateStats()}async saveListifyArticle(e,i,t){let s=new Date,r=s.getFullYear(),n=String(s.getMonth()+1).padStart(2,"0"),a=String(s.getDate()).padStart(2,"0"),l=String(s.getHours()).padStart(2,"0"),y=String(s.getMinutes()).padStart(2,"0"),g=String(s.getSeconds()).padStart(2,"0"),A=this.formatTimestamp(this.plugin.settings.timestampFormat,s),E=e.split(`
`)[0]||"",w=this.removeWikilinkBrackets(E).replace(/[\/\\?%*:|"<>]/g,"_").replace(/\s+/g,"_").trim(),b=`${A}_listify_${w}.md`,D=this.plugin.settings.notificationFolder||"Archives/Notifications",I=this.getDateFolderPath(D,s);await this.ensureFolderExists(I);let B=[...this.extractWikilinks(e),...this.extractWikilinks(`[[${i}]]`)],T=Array.from(new Set(B)),k=this.sanitizeContext(this.removeWikilinkBrackets(E)),v=`---
type: listify`;if(k&&(v+=`
context: "${k}"`),T.length>0){v+=`
links:`;for(let f of T)v+=`
  - "${f}"`}v+=`
created: "${this.toJSTISOString(s)}"
---

${e}

---

`;let u=t.map(f=>`- [ ] ${f}`).join(`
`),m=`${I}/${b}`;await this.app.vault.create(m,v+u),await this.updateGrass(),await this.updateStats()}async callLLMForListify(e,i,t,s,r){let n=this.plugin.settings;try{let a=`\u4EE5\u4E0B\u306E\u8A18\u4E8B\u300C${i}\u300D\u306E\u5185\u5BB9\u3092\u53C2\u7167\u3057\u3066\u3001\u300C${e}\u300D\u306B\u95A2\u3059\u308B\u30C1\u30A7\u30C3\u30AF\u30EA\u30B9\u30C8\u3092\u4F5C\u6210\u3057\u3066\u304F\u3060\u3055\u3044\u3002

# \u8A18\u4E8B\u5185\u5BB9
${t}

# \u8981\u6C42\u4E8B\u9805
\u4E0A\u8A18\u306E\u8A18\u4E8B\u5185\u5BB9\u3092\u3082\u3068\u306B\u3001\u300C${e}\u300D\u3068\u3044\u3046\u6587\u8108\u306B\u95A2\u9023\u3059\u308B\u884C\u52D5\u30C1\u30A7\u30C3\u30AF\u30EA\u30B9\u30C8\u3092\u4F5C\u6210\u3057\u3066\u304F\u3060\u3055\u3044\u3002  
\u76EE\u7684\u306F\u3001\u305D\u306E\u6587\u8108\u3067\u5B9F\u8DF5\u30FB\u691C\u8A0E\u30FB\u6539\u5584\u3059\u3079\u304D\u30A2\u30AF\u30B7\u30E7\u30F3\u3092\u62BD\u51FA\u3059\u308B\u3053\u3068\u3067\u3059\u3002

## \u4F5C\u6210\u30EB\u30FC\u30EB
1. \u5404\u9805\u76EE\u306F\u81EA\u7136\u306A\u65E5\u672C\u8A9E\u306E\u4E00\u6587\u3067\u66F8\u304F\u3053\u3068\u3002  
2. \u5404\u6587\u306F\u300C\u301C\u3057\u3066\u3007\u3007\u3059\u308B\u300D\u300C\u301C\u306E\u305F\u3081\u306B\u3007\u3007\u3059\u308B\u300D\u306E\u3088\u3046\u306B\u3001\u884C\u52D5\u3068\u610F\u56F3\u3092\u542B\u3081\u308B\u3053\u3068\u3002  
3. \u5404\u9805\u76EE\u306F50\u6587\u5B57\u524D\u5F8C\u3092\u76EE\u5B89\u3068\u3059\u308B\u3002  
4. \u51FA\u529B\u306F\u30C1\u30A7\u30C3\u30AF\u30EA\u30B9\u30C8\u5F62\u5F0F\uFF08- [ ]\uFF09\u306E\u307F\u3068\u3057\u3001\u4ED6\u306E\u8AAC\u660E\u3084\u898B\u51FA\u3057\u306F\u4E0D\u8981\u3002  
5. \u8A18\u53F7\u300C\uFF1A\u300D\u3084\u62EC\u5F27\u3092\u4F7F\u308F\u305A\u3001\u81EA\u7136\u306A\u6587\u7AE0\u3067\u76EE\u7684\u3092\u8868\u73FE\u3059\u308B\u3002

# \u51FA\u529B\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8\u4F8B
- [ ] \u9031\u306B\u4E00\u5EA6\u30C7\u30FC\u30BF\u3092\u30D0\u30C3\u30AF\u30A2\u30C3\u30D7\u3057\u3066\u640D\u5931\u306B\u5099\u3048\u308B  
- [ ] \u30C1\u30FC\u30E0\u3067\u9032\u6357\u3092\u5171\u6709\u3057\u3066\u8A8D\u8B58\u3092\u305D\u308D\u3048\u308B  
- [ ] \u5B9F\u9A13\u624B\u9806\u3092\u6574\u7406\u3057\u3066\u518D\u73FE\u6027\u3092\u9AD8\u3081\u308B`,l="";if(s==="openai"&&n.openaiApiKey)l=await this.callOpenAI(a,n.openaiApiKey,r);else if(s==="claude"&&n.claudeApiKey)l=await this.callClaude(a,n.claudeApiKey,r);else if(s==="groq"&&n.groqApiKey)l=await this.callGroq(a,n.groqApiKey,r);else return new h.Notice("\u274C API Key\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u753B\u9762\u3067API Key\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),null;return l.split(`
`).filter(g=>g.trim().startsWith("- [ ]")).map(g=>g.replace(/^-\s*\[\s*\]\s*/,"").trim())}catch(a){console.error("Listify Error:",a);let l=a instanceof Error?a.message:String(a);return new h.Notice(`\u274C \u30A8\u30E9\u30FC: ${l}`),null}}async callLLMForDeepDive(e,i,t,s,r){let n=this.plugin.settings;try{let a=`${e}\u3068\u3044\u3046\u6587\u8108\u3067\u4EE5\u4E0B\u306E\u53C2\u7167\u30C6\u30AD\u30B9\u30C8\u3092\u5206\u304B\u308A\u3084\u3059\u304F\u307E\u3068\u3081\u3066\u304F\u3060\u3055\u3044\u3002

\u3010\u91CD\u8981\u306A\u6307\u793A\u3011
1. \u53C2\u7167\u30C6\u30AD\u30B9\u30C8\u306F\u97F3\u58F0\u5165\u529B\u306E\u6587\u5B57\u8D77\u3053\u3057\u3067\u3042\u308B\u53EF\u80FD\u6027\u304C\u3042\u308A\u3001\u8A9E\u5C3E\u306E\u4E0D\u81EA\u7136\u3055\u3084\u9014\u4E2D\u3067\u6B62\u307E\u3063\u305F\u8868\u73FE\u3001\u9069\u5F53\u306A\u53E5\u8AAD\u70B9\u306A\u3069\u304C\u542B\u307E\u308C\u3066\u3044\u307E\u3059
2. \u5143\u306E\u6587\u7AE0\u3092\u305D\u306E\u307E\u307E\u5F15\u7528\u305B\u305A\u3001\u5185\u5BB9\u3092\u7406\u89E3\u3057\u305F\u4E0A\u3067\u66F8\u304D\u8A00\u8449\u3068\u3057\u3066\u81EA\u7136\u3067\u8AAD\u307F\u3084\u3059\u3044\u6587\u7AE0\u306B\u4FEE\u6B63\u30FB\u6574\u7406\u3057\u3066\u304F\u3060\u3055\u3044
3. \u5143\u306E\u30C6\u30AD\u30B9\u30C8\u306B\u8A18\u8F09\u3055\u308C\u3066\u3044\u306A\u3044\u60C5\u5831\u3084\u5F0F\u3001\u6570\u5F0F\u3092\u8FFD\u52A0\u3057\u306A\u3044\u3067\u304F\u3060\u3055\u3044
4. \u6587\u8108\u5916\u306E\u8A18\u53F7\u3001\u4F1A\u8A71\u3001\u95A2\u4FC2\u306E\u306A\u3044\u30E1\u30BF\u30C7\u30FC\u30BF\u306F\u8A18\u8F09\u3057\u306A\u3044\u3067\u304F\u3060\u3055\u3044
5. h1\u30BF\u30B0\u3084\u30BF\u30A4\u30C8\u30EB\u306F\u8A18\u8F09\u305B\u305A\u3001h2\u30BF\u30B0\u306E\u30B5\u30D6\u30BF\u30A4\u30C8\u30EB\u304B\u3089\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044
6. \u60C5\u5831\u3092\u30B0\u30EB\u30FC\u30D7\u5316\u3057\u3001\u8981\u70B9\u3092\u660E\u78BA\u306B\u3057\u3066\u304F\u3060\u3055\u3044
7. \u66D6\u6627\u306A\u60C5\u5831\u3084\u4E0D\u660E\u306A\u70B9\u304C\u3042\u308B\u5834\u5408\u306F\u3001\u300C\u8A73\u7D30\u306F\u4E0D\u660E\u300D\u300C\u8A18\u8F09\u306A\u3057\u300D\u3068\u660E\u8A18\u3057\u3066\u304F\u3060\u3055\u3044
8. \u8A71\u3057\u8A00\u8449\u306E\u7279\u5FB4\uFF08\u300C\u3048\u30FC\u300D\u300C\u3042\u306E\u300D\u306A\u3069\uFF09\u306F\u9664\u53BB\u3057\u3001\u66F8\u304D\u8A00\u8449\u3068\u3057\u3066\u9069\u5207\u306A\u8868\u73FE\u306B\u3057\u3066\u304F\u3060\u3055\u3044

\u51FA\u529B\u306F\u30DE\u30FC\u30AF\u30C0\u30A6\u30F3\u5F62\u5F0F\u3067\u3001\u8AAD\u307F\u3084\u3059\u304F\u6574\u7406\u3055\u308C\u305F\u8981\u7D04\u3068\u3057\u3066\u8A18\u8FF0\u3057\u3066\u304F\u3060\u3055\u3044\u3002

---
\u3010\u53C2\u7167\u30C6\u30AD\u30B9\u30C8\u3011
${r}
---`,l="";if(i==="openai"&&n.openaiApiKey)l=await this.callOpenAI(a,n.openaiApiKey,t);else if(i==="claude"&&n.claudeApiKey)l=await this.callClaude(a,n.claudeApiKey,t);else if(i==="groq"&&n.groqApiKey)l=await this.callGroq(a,n.groqApiKey,t);else return new h.Notice("\u274C API Key\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u753B\u9762\u3067API Key\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),null;return l}catch(a){console.error("DeepDive Error:",a);let l=a instanceof Error?a.message:String(a);return new h.Notice(`\u274C \u30A8\u30E9\u30FC: ${l}`),null}}async callOpenAI(e,i,t){var n;let s=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:t||"gpt-4o-mini",messages:[{role:"user",content:e}]})});if(!s.ok){let a=await s.json().catch(()=>({}));throw new Error(`OpenAI API error: ${s.status} - ${((n=a.error)==null?void 0:n.message)||s.statusText}`)}return(await s.json()).choices[0].message.content}async callClaude(e,i,t){var n;let s=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":i,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:t||"claude-3-5-sonnet-20241022",max_tokens:1024,messages:[{role:"user",content:e}]})});if(!s.ok){let a=await s.json().catch(()=>({}));throw new Error(`Claude API error: ${s.status} - ${((n=a.error)==null?void 0:n.message)||s.statusText}`)}return(await s.json()).content[0].text}async callGroq(e,i,t){var n;let s=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:t||"llama-3.1-70b-versatile",messages:[{role:"user",content:e}]})});if(!s.ok){let a=await s.json().catch(()=>({}));throw new Error(`Groq API error: ${s.status} - ${((n=a.error)==null?void 0:n.message)||s.statusText}`)}return(await s.json()).choices[0].message.content}getFrontmatter(e){let i=e.match(/^---\n([\s\S]*?)\n---/);if(!i)return null;let t=i[1],s={};return t.split(`
`).forEach(r=>{let n=r.match(/^(\w+):\s*(.+)$/);if(n){let a=n[1],l=n[2];(l.startsWith('"')&&l.endsWith('"')||l.startsWith("'")&&l.endsWith("'"))&&(l=l.slice(1,-1)),s[a]=l}}),s}switchTab(e){let i=this.containerEl.querySelectorAll(".brainstall-tab"),t=this.contentContainer.children;i.forEach(s=>{s.getAttribute("data-tab")===e?s.addClass("active"):s.removeClass("active")}),Array.from(t).forEach(s=>{s.hasClass("active")&&(s.removeClass("active"),s.addClass("hidden"))}),e==="posts"?(this.postsContainer.removeClass("hidden"),this.postsContainer.addClass("active")):e==="stats"?(this.statsContainer.removeClass("hidden"),this.statsContainer.addClass("active"),this.updateStats(),this.updateGrass()):e==="reference"&&(this.referenceContainer.removeClass("hidden"),this.referenceContainer.addClass("active"),this.updateReference())}async openEditorFromContent(e,i=null){let t=new Date,s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),y=String(t.getSeconds()).padStart(2,"0"),g=this.formatTimestamp(this.plugin.settings.timestampFormat,t),E=(e.split(`
`)[0]||e.slice(0,30)).slice(0,50).replace(/[\/\\?%*:|"<>]/g,"_"),W=`${g}_article_${E}.md`,w=this.plugin.settings.notificationFolder||"Archives/Notifications",b=this.getDateFolderPath(w,t);await this.ensureFolderExists(b);let D=`---
type: article
context: "${e}"
created: "${this.toJSTISOString(t)}"`;i&&(D+=`
source: "[[${i.basename}]]"`),D+=`
---

${e}`;let I=`${b}/${W}`,B=await this.app.vault.create(I,D),T=this.app.workspace.getLeaf(!0);await T.openFile(B),await new Promise(k=>setTimeout(k,100)),await T.setViewState({type:"markdown",state:{file:B.path,mode:"source"}}),new h.Notice("\u901A\u77E5\u30D5\u30A1\u30A4\u30EB\u3092\u4F5C\u6210\u3057\u307E\u3057\u305F\u3002"),await this.updatePosts(),await this.updateGrass(),await this.updateStats()}async extractHashtags(e){let i=new Set;for(let t of e)try{let r=(await this.app.vault.read(t)).matchAll(/#[\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+/g);for(let n of r)i.add(n[0].toLowerCase())}catch(s){}return Array.from(i).sort()}async updatePosts(){var lt,ot;let e=(lt=this.postsContainer)==null?void 0:lt.querySelector(".brainstall-posts-list"),i=e?e.scrollTop:0,t=this.plugin.settings.notificationFolder||"Archives/Notifications",s=this.app.vault.getFiles().filter(d=>d.path.startsWith(t+"/")),r=await Promise.all(s.map(async d=>{let c=new Date(0),S=!1;try{let M=await this.app.vault.read(d),H=this.getFrontmatter(M);if(H!=null&&H.created)c=new Date(H.created);else{let R=d.path.match(/(\d{8})_(\d{6})/);if(R){let U=R[1],X=R[2];c=new Date(parseInt(U.substring(0,4)),parseInt(U.substring(4,6))-1,parseInt(U.substring(6,8)),parseInt(X.substring(0,2)),parseInt(X.substring(2,4)),parseInt(X.substring(4,6)))}else c=new Date(d.stat.mtime)}S=M.includes("pinned: true")}catch(M){c=new Date(d.stat.mtime)}return{file:d,date:c,isPinned:S}})),n=r.sort((d,c)=>d.isPinned&&!c.isPinned?-1:!d.isPinned&&c.isPinned?1:c.date.getTime()-d.date.getTime()).map(d=>d.file),a=await this.extractHashtags(n),l=new Set;r.forEach(d=>{let c=d.date.toISOString().slice(0,10);l.add(c)});let y=Array.from(l).sort().reverse();if(this.postsContainer.empty(),n.length===0){this.postsContainer.createEl("p",{text:"\u307E\u3060\u901A\u77E5\u304C\u3042\u308A\u307E\u305B\u3093",cls:"brainstall-empty"});return}let g=this.postsContainer.createEl("div",{cls:"brainstall-posts-header"}),A=0;for(let d=0;d<n.length;d++){let c=n[d],S=await this.app.vault.read(c),M=S.includes("archived: true")||S.includes("status: archived");if(!(!this.showArchived&&M)){if(this.searchKeyword&&this.searchKeyword.startsWith("#")){let H=this.searchKeyword.toLowerCase();if(!S.toLowerCase().includes(H))continue}if(this.searchDate){let H=r.find(R=>R.file.path===c.path);if(H&&H.date.toISOString().slice(0,10)!==this.searchDate)continue}this.searchType&&!S.includes(`type: ${this.searchType}`)||A++}}let E=g.createEl("div",{cls:"brainstall-header-title-row"});E.createEl("h3",{text:`\u5168\u3066\u306E\u901A\u77E5 (${A}\u4EF6)`}),E.createEl("button",{text:"\u{1F504}",cls:"brainstall-refresh-btn",attr:{title:"\u66F4\u65B0"}}).addEventListener("click",async()=>{await this.updatePosts(),await this.updateGrass(),await this.updateStats(),new h.Notice("\u66F4\u65B0\u3057\u307E\u3057\u305F")});let w=g.createEl("div",{cls:"brainstall-header-filter-row"}),b=w.createEl("select",{cls:"brainstall-hashtag-select"});b.createEl("option",{text:"\u{1F50D} \u30CF\u30C3\u30B7\u30E5\u30BF\u30B0",value:""}),a.forEach(d=>{let c=b.createEl("option",{text:d,value:d})}),this.searchKeyword&&(b.value=this.searchKeyword),b.addEventListener("change",d=>{let c=d.target;this.searchKeyword=c.value,this.updatePosts()});let D=w.createEl("select",{cls:"brainstall-date-select"});D.createEl("option",{text:"\u{1F4C5} \u65E5\u4ED8",value:""}),y.forEach(d=>{let S=new Date(d).toLocaleDateString("ja-JP",{year:"numeric",month:"short",day:"numeric"});D.createEl("option",{text:S,value:d})}),this.searchDate&&(D.value=this.searchDate),D.addEventListener("change",d=>{let c=d.target;this.searchDate=c.value,this.updatePosts()});let I=w.createEl("select",{cls:"brainstall-type-select"});I.createEl("option",{text:"\u30BF\u30A4\u30D7",value:""}),["memo","listify","text","audio","images","deepDive"].forEach(d=>{let c={memo:"\u{1F4DD} \u30E1\u30E2",listify:"\u{1F4CB} \u30EA\u30B9\u30C8",text:"\u2328\uFE0F \u30AD\u30FC\u30DC\u30FC\u30C9\u5165\u529B",audio:"\u{1F3A4} \u30DC\u30A4\u30B9\u30E1\u30E2",images:"\u{1F4F7} \u9023\u7D9A\u64AE\u5F71",deepDive:"\u{1F50D} \u6DF1\u6398\u308A"};I.createEl("option",{text:c[d]||d,value:d})}),this.searchType&&(I.value=this.searchType),I.addEventListener("change",d=>{let c=d.target;this.searchType=c.value,this.updatePosts()});let T=w.createEl("div",{cls:"brainstall-priority-select-wrapper"});T.style.position="relative",T.style.flex="1",T.style.minWidth="120px",T.style.maxWidth="400px";let k=T.createEl("div",{cls:"brainstall-priority-select-display"});k.style.padding="4px 8px",k.style.border="1px solid var(--background-modifier-border)",k.style.borderRadius="4px",k.style.background="var(--background-primary)",k.style.color="var(--text-normal)",k.style.fontSize="13px",k.style.cursor="pointer",k.style.display="flex",k.style.alignItems="center",k.style.justifyContent="space-between";let v=k.createEl("span",{text:this.selectedPriorities.length>0?`\u2B50 ${this.selectedPriorities.sort((d,c)=>d-c).join(", ")}`:"\u2B50 \u661F\u306E\u6570"}),u=k.createEl("span",{text:"\u25BC",cls:"brainstall-priority-select-arrow"});u.style.fontSize="10px",u.style.color="var(--text-muted)",u.style.marginLeft="8px";let m=T.createEl("div",{cls:"brainstall-priority-dropdown-list"});m.style.display="none",m.style.position="absolute",m.style.top="100%",m.style.left="0",m.style.right="0",m.style.background="var(--background-primary)",m.style.border="1px solid var(--background-modifier-border)",m.style.borderRadius="4px",m.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",m.style.marginTop="4px",m.style.maxHeight="200px",m.style.overflowY="auto",m.style.zIndex="1000",m.addEventListener("click",d=>{d.stopPropagation(),d.stopImmediatePropagation()},!0),m.addEventListener("mousedown",d=>{d.stopPropagation(),d.stopImmediatePropagation()},!0);for(let d=0;d<=5;d++){let c=m.createEl("label",{cls:"brainstall-priority-option-item"});c.style.display="flex",c.style.alignItems="center",c.style.padding="4px 8px",c.style.cursor="pointer",c.style.borderBottom="1px solid var(--background-modifier-border)",c.style.fontSize="12px",c.addEventListener("mouseenter",()=>{c.style.background="var(--background-modifier-hover)"}),c.addEventListener("mouseleave",()=>{c.style.background="transparent"});let S=c.createEl("input",{type:"checkbox",cls:"brainstall-priority-option-checkbox"});S.value=d.toString(),S.checked=this.selectedPriorities.includes(d),S.style.marginRight="6px",S.style.width="14px",S.style.height="14px",S.style.cursor="pointer";let M=c.createEl("span",{text:"\u2B50".repeat(d)+(d===0?"\u306A\u3057":"")});M.style.fontSize="11px",M.style.lineHeight="1.2",d>0&&(M.style.display="inline-block",M.style.transform="scale(0.85)",M.style.transformOrigin="left center"),S.addEventListener("click",H=>{H.stopPropagation(),H.stopImmediatePropagation()},!0),S.addEventListener("mousedown",H=>{H.stopPropagation(),H.stopImmediatePropagation()},!0),S.addEventListener("change",H=>{H.stopPropagation(),S.checked?this.selectedPriorities.includes(d)||this.selectedPriorities.push(d):this.selectedPriorities=this.selectedPriorities.filter(R=>R!==d),v.textContent=this.selectedPriorities.length>0?`\u2B50 ${this.selectedPriorities.sort((R,U)=>R-U).join(", ")}`:"\u2B50 \u661F\u306E\u6570",this.updatePosts()}),c.addEventListener("click",H=>{H.stopPropagation(),H.stopImmediatePropagation()},!0),c.addEventListener("mousedown",H=>{H.stopPropagation(),H.stopImmediatePropagation()},!0)}let f=!1,L=null;k.addEventListener("click",d=>{d.stopPropagation(),f=!f,m.style.display=f?"block":"none",f?(u.textContent="\u25B2",L&&document.removeEventListener("mousedown",L),L=c=>{let S=c.target;S&&!T.contains(S)&&(f=!1,m.style.display="none",u.textContent="\u25BC",L&&(document.removeEventListener("mousedown",L),L=null))},setTimeout(()=>{document.addEventListener("mousedown",L,!0)},0)):(u.textContent="\u25BC",L&&(document.removeEventListener("mousedown",L),L=null))}),this.searchKeyword&&w.createEl("button",{text:"\u2715 \u89E3\u9664",cls:"brainstall-clear-btn",attr:{title:"\u30D5\u30A3\u30EB\u30BF\u30FC\u3092\u89E3\u9664"}}).addEventListener("click",c=>{c.stopPropagation(),this.searchKeyword="",this.updatePosts()}),w.createEl("button",{text:this.showArchived?"\u3059\u3079\u3066":"\u30A2\u30AF\u30C6\u30A3\u30D6",cls:"brainstall-filter-btn"}).addEventListener("click",()=>{this.showArchived=!this.showArchived,this.updatePosts(),this.updateStats()});let q=this.postsContainer.createEl("div",{cls:"brainstall-posts-list"});for(let d=0;d<n.length;d++){let c=n[d],S=await this.app.vault.read(c),M=this.getFrontmatter(S),H=S.includes("archived: true")||S.includes("status: archived"),R=S.includes("pinned: true"),U=S.includes("type: deepDive"),X=S.includes("type: listify"),ct="",St=S.includes("context:"),yt=S.match(/context:\s*"([^"]*)"/);if(yt&&(ct=yt[1]),!this.showArchived&&H)continue;if(this.searchKeyword&&this.searchKeyword.startsWith("#")){let p=this.searchKeyword.toLowerCase();if(!S.toLowerCase().includes(p))continue}if(this.searchDate){let p=r.find(o=>o.file.path===c.path);if(p&&p.date.toISOString().slice(0,10)!==this.searchDate)continue}if(this.searchType&&!S.includes(`type: ${this.searchType}`))continue;if(this.selectedPriorities.length>0){let p=M!=null&&M.priority?Number(M.priority):0;if(!this.selectedPriorities.includes(p))continue}let Z=q.createEl("div",{cls:"brainstall-post"}),pt=null;if(M!=null&&M.created)pt=new Date(M.created);else{let p=c.path.match(/(\d{8})_(\d{6})/);if(p){let o=p[1],x=p[2];pt=new Date(parseInt(o.substring(0,4)),parseInt(o.substring(4,6))-1,parseInt(o.substring(6,8)),parseInt(x.substring(0,2)),parseInt(x.substring(2,4)),parseInt(x.substring(4,6)))}}let vt=Z.createEl("div",{cls:"brainstall-date-priority-container"});pt&&vt.createEl("div",{text:pt.toLocaleString("ja-JP",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}),cls:"brainstall-post-date"});let xt=M!=null&&M.priority?Number(M.priority):0,Tt=vt.createEl("div",{cls:"brainstall-priority-stars"});for(let p=1;p<=5;p++){let o=p<=xt,x=Tt.createEl("span",{text:o?"\u2B50\uFE0F":"\u2606",cls:`brainstall-priority-star ${o?"filled":"blank"}`});x.setAttribute("data-priority",p.toString()),x.addEventListener("click",async O=>{O.stopPropagation();let C=M!=null&&M.priority?Number(M.priority):0,P=p<C?p:p===C?Math.max(0,p-1):p;await this.setPriority(c,P)})}H&&Z.addClass("archived"),R&&Z.addClass("pinned");let ut=Z.createEl("div",{cls:"brainstall-post-content"}),wt=S.replace(/^---[\s\S]*?---\n?/,"").trim().split(`
`).slice(0,3).join(`
`).trim();wt?(h.MarkdownRenderer.renderMarkdown(wt,ut,c.path,this),ut.addEventListener("click",p=>{let x=p.target.closest("a");if(x){p.preventDefault(),p.stopPropagation();let O=x.getAttribute("href"),C=x.textContent||"";if(C.startsWith("#")){let P=C.toLowerCase();this.searchKeyword=P,this.updatePosts();return}if(console.log("Link clicked:",O),O)if(O.startsWith("#search")){let P=O.substring(1);this.app.workspace.openLinkText(P,c.path,!1)}else if(O.startsWith("http://")||O.startsWith("https://"))window.open(O,"_blank");else{let P=x.getAttribute("data-href");P&&this.app.workspace.openLinkText(P,c.path,!1)}}})):ut.textContent="(\u7A7A)";let bt=Z.createEl("div",{cls:"brainstall-post-actions"}).createEl("div",{cls:"brainstall-right-actions"});bt.createEl("button",{text:R?"\u{1F4CC}":"\u{1F4CD}",attr:{title:R?"\u30D4\u30F3\u7559\u3081\u3092\u89E3\u9664":"\u30D4\u30F3\u7559\u3081"}}).addEventListener("click",async p=>{p.stopPropagation(),await this.togglePin(c)});let Et=bt.createEl("button",{text:"\u{1F517}"});Et.setAttribute("title","\u5171\u6709"),Et.addEventListener("click",async p=>{p.stopPropagation(),await this.sharePost(c)});let et=Z.createEl("div",{cls:"brainstall-bottom-actions"}),J=et.createEl("button",{text:"\u{1F5D1}\uFE0F \u524A\u9664",cls:"brainstall-bottom-action-btn"});J.style.position="relative",J.style.overflow="hidden";let N=J.createEl("div",{cls:"brainstall-progress-bar"});N.style.position="absolute",N.style.left="0",N.style.top="0",N.style.height="100%",N.style.width="0%",N.style.background="var(--interactive-accent)",N.style.opacity="0.3",N.style.transition="width 0.1s linear",N.style.zIndex="0",N.style.pointerEvents="none",J.style.zIndex="1",J.style.position="relative";let Q=null,st=!1,G=null,tt=!1,_=null,it=!1;if(J.addEventListener("mousedown",()=>{st=!1,tt=!0,it=!1,N.style.width="0%",_&&(clearTimeout(_),_=null);let p=Date.now();G=window.setInterval(()=>{let o=Date.now()-p,x=Math.min(o/1e3*100,100);N.style.width=`${x}%`},10),Q=window.setTimeout(async()=>{Q=null,G&&(clearInterval(G),G=null),N.style.width="100%",it=!1,_=window.setTimeout(async()=>{if(_=null,it||st){N.style.width="0%";return}st=!0,tt=!1,await this.deletePost(c),N.style.width="0%"},50)},1e3)}),J.addEventListener("mouseup",()=>{Q&&(tt=!0,clearTimeout(Q),Q=null),_&&(it=!0,clearTimeout(_),_=null),G&&(clearInterval(G),G=null),N.style.width="0%"}),J.addEventListener("mouseleave",()=>{Q&&(tt=!0,clearTimeout(Q),Q=null),_&&(it=!0,clearTimeout(_),_=null),G&&(clearInterval(G),G=null),N.style.width="0%"}),J.addEventListener("click",async p=>{if(p.stopPropagation(),st){st=!1,tt=!1;return}if(tt){tt=!1;return}await this.deletePost(c)}),H){let p=et.createEl("button",{text:"\u{1F4C1} \u5FA9\u5143",cls:"brainstall-bottom-action-btn"});p.style.position="relative",p.style.overflow="hidden";let o=p.createEl("div",{cls:"brainstall-progress-bar"});o.style.position="absolute",o.style.left="0",o.style.top="0",o.style.height="100%",o.style.width="0%",o.style.background="var(--interactive-accent)",o.style.opacity="0.3",o.style.transition="width 0.1s linear",o.style.zIndex="0",o.style.pointerEvents="none",p.style.zIndex="1",p.style.position="relative";let x=null,O=!1,C=null,P=!1,F=null,z=!1;p.addEventListener("mousedown",()=>{O=!1,P=!0,z=!1,o.style.width="0%",F&&(clearTimeout(F),F=null);let j=Date.now();C=window.setInterval(()=>{let nt=Date.now()-j,at=Math.min(nt/1e3*100,100);o.style.width=`${at}%`},10),x=window.setTimeout(async()=>{x=null,C&&(clearInterval(C),C=null),o.style.width="100%",z=!1,F=window.setTimeout(async()=>{if(F=null,z||O){o.style.width="0%";return}O=!0,P=!1,await this.archivePost(c,!1,!0),o.style.width="0%"},50)},1e3)}),p.addEventListener("mouseup",()=>{x&&(P=!0,clearTimeout(x),x=null),F&&(z=!0,clearTimeout(F),F=null),C&&(clearInterval(C),C=null),o.style.width="0%"}),p.addEventListener("mouseleave",()=>{x&&(P=!0,clearTimeout(x),x=null),F&&(z=!0,clearTimeout(F),F=null),C&&(clearInterval(C),C=null),o.style.width="0%"}),p.addEventListener("click",async j=>{if(j.stopPropagation(),O){O=!1,P=!1;return}if(P){P=!1;return}await this.archivePost(c,!1,!0)})}else{let p=et.createEl("button",{text:"\u{1F4C1} \u30A2\u30FC\u30AB\u30A4\u30D6",cls:"brainstall-bottom-action-btn"});p.style.position="relative",p.style.overflow="hidden";let o=p.createEl("div",{cls:"brainstall-progress-bar"});o.style.position="absolute",o.style.left="0",o.style.top="0",o.style.height="100%",o.style.width="0%",o.style.background="var(--interactive-accent)",o.style.opacity="0.3",o.style.transition="width 0.1s linear",o.style.zIndex="0",o.style.pointerEvents="none",p.style.zIndex="1",p.style.position="relative";let x=null,O=!1,C=null,P=!1,F=null,z=!1;p.addEventListener("mousedown",()=>{O=!1,P=!0,z=!1,o.style.width="0%",F&&(clearTimeout(F),F=null);let j=Date.now();C=window.setInterval(()=>{let nt=Date.now()-j,at=Math.min(nt/1e3*100,100);o.style.width=`${at}%`},10),x=window.setTimeout(async()=>{x=null,C&&(clearInterval(C),C=null),o.style.width="100%",z=!1,F=window.setTimeout(async()=>{if(F=null,z||O){o.style.width="0%";return}O=!0,P=!1,await this.archivePost(c,!0,!0),o.style.width="0%"},50)},1e3)}),p.addEventListener("mouseup",()=>{x&&(P=!0,clearTimeout(x),x=null),F&&(z=!0,clearTimeout(F),F=null),C&&(clearInterval(C),C=null),o.style.width="0%"}),p.addEventListener("mouseleave",()=>{x&&(P=!0,clearTimeout(x),x=null),F&&(z=!0,clearTimeout(F),F=null),C&&(clearInterval(C),C=null),o.style.width="0%"}),p.addEventListener("click",async j=>{if(j.stopPropagation(),O){O=!1,P=!1;return}if(P){P=!1;return}await this.archivePost(c,!0,!0)})}if(St){let p=et.createEl("button",{text:"Topics\u306B\u8FFD\u52A0",cls:"brainstall-bottom-action-btn"});p.setAttribute("title","Topics\u306B\u8FFD\u52A0"),p.style.position="relative",p.style.overflow="hidden";let o=p.createEl("div",{cls:"brainstall-progress-bar"});o.style.position="absolute",o.style.left="0",o.style.top="0",o.style.height="100%",o.style.width="0%",o.style.background="var(--interactive-accent)",o.style.opacity="0.3",o.style.transition="width 0.1s linear",o.style.zIndex="0",o.style.pointerEvents="none",p.style.zIndex="1",p.style.position="relative";let x=null,O=!1,C=null,P=!1,F=null,z=!1;p.addEventListener("mousedown",()=>{O=!1,P=!0,z=!1,o.style.width="0%",F&&(clearTimeout(F),F=null);let j=Date.now();C=window.setInterval(()=>{let nt=Date.now()-j,at=Math.min(nt/1e3*100,100);o.style.width=`${at}%`},10),x=window.setTimeout(async()=>{x=null,C&&(clearInterval(C),C=null),o.style.width="100%",z=!1,F=window.setTimeout(async()=>{if(F=null,z||O){o.style.width="0%";return}O=!0,P=!1,await this.moveToTopics(c,!0),o.style.width="0%"},50)},1e3)}),p.addEventListener("mouseup",()=>{x&&(P=!0,clearTimeout(x),x=null),F&&(z=!0,clearTimeout(F),F=null),C&&(clearInterval(C),C=null),o.style.width="0%"}),p.addEventListener("mouseleave",()=>{x&&(P=!0,clearTimeout(x),x=null),F&&(z=!0,clearTimeout(F),F=null),C&&(clearInterval(C),C=null),o.style.width="0%"}),p.addEventListener("click",async j=>{if(j.stopPropagation(),O){O=!1,P=!1;return}if(P){P=!1;return}await this.moveToTopics(c,!0)})}else et.createEl("div");Z.addEventListener("click",p=>{let o=p.target;o.textContent&&o.textContent.startsWith("#")||o.closest("a")||this.app.workspace.openLinkText(c.path,"",!1)})}let $=(ot=this.postsContainer)==null?void 0:ot.querySelector(".brainstall-posts-list");$&&i>0&&requestAnimationFrame(()=>{$.scrollTop=i})}async updateGrass(){let e=["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"];this.grassContainer.empty();let i=await this.getPostStats(),t=Math.max(...Object.values(i),1),s=this.grassContainer.createEl("div",{cls:"brainstall-grass-grid"}),r=s.createEl("div",{cls:"brainstall-grass-row header"});r.createEl("div",{text:""});for(let l=0;l<=11;l++)r.createEl("div",{text:"",cls:"brainstall-grass-day-header"});let n=new Date,a=n.getDay();for(let l=0;l<7;l++){let y=s.createEl("div",{cls:"brainstall-grass-row"});y.createEl("div",{text:e[l],cls:"brainstall-grass-week-label"});for(let g=0;g<=11;g++){let A=11-g,E=a,w=A*7+E-l,b=new Date(n);b.setDate(b.getDate()-w);let D=`${b.getFullYear()}${String(b.getMonth()+1).padStart(2,"0")}${String(b.getDate()).padStart(2,"0")}`,I=i[D]||0,B=I>0?Math.min(.3+I/t*.7,1):0,T=y.createEl("div",{cls:"brainstall-grass-cell",attr:{title:`${b.toLocaleDateString("ja-JP")}: ${I}\u901A\u77E5`}});I>0?(T.textContent=String(I),T.style.backgroundColor=`color-mix(in srgb, var(--interactive-accent) ${B*100}%, transparent)`,T.style.color=B>.6?"white":"var(--text-normal)",T.style.opacity="1"):(T.style.backgroundColor="var(--background-modifier-border)",T.style.opacity="0.3")}}}async getPostStats(){let e={},i=this.plugin.settings.notificationFolder||"Archives/Notifications";try{let t=this.app.vault.getFiles();for(let s of t)if(s.path.startsWith(i+"/")){let r=null;try{let n=await this.app.vault.read(s),a=this.getFrontmatter(n);a!=null&&a.created&&(r=new Date(a.created).toISOString().slice(0,10).replace(/-/g,""))}catch(n){let a=s.path.match(/(\d{8})\//);a&&(r=a[1])}if(!r){let n=s.path.match(/(\d{8})\//);n&&(r=n[1])}r&&(e[r]=(e[r]||0)+1)}}catch(t){console.error("Stats error:",t)}return e}async updateStats(){let e=this.plugin.settings.notificationFolder||"Archives/Notifications",i=this.app.vault.getFiles().filter(b=>b.path.startsWith(e+"/")),t=i.length,s=new Set,r=0,n=0,a=0;for(let b of i)try{let D=await this.app.vault.read(b);r+=D.length,D.includes("archived: true")||D.includes("status: archived")?a++:n++;let B=this.getFrontmatter(D),T=null;if(B!=null&&B.created&&(T=new Date(B.created).toISOString().slice(0,10).replace(/-/g,"")),!T){let k=b.path.match(/(\d{8})\//);k&&(T=k[1])}T&&s.add(T)}catch(D){}let l=s.size,y=l>0?Math.round(r/l).toLocaleString():"0";this.statsContainer.empty(),this.statsContainer.createEl("h3",{text:"\u{1F4C5} \u9032\u6357",cls:"brainstall-grass-title"}),this.grassContainer=this.statsContainer.createEl("div",{cls:"brainstall-grass"}),this.statsContainer.createEl("h3",{text:"\u{1F4CA} \u7D71\u8A08",cls:"brainstall-grass-title",attr:{style:"margin-top: 30px;"}});let g=this.statsContainer.createEl("div",{cls:"brainstall-stats-grid"}),A=g.createEl("div",{cls:"brainstall-stat-card"});A.createEl("div",{text:"\u{1F4DD} \u30A2\u30FC\u30AB\u30A4\u30D6\u6570",cls:"brainstall-stat-label"}),A.createEl("div",{text:`${a} / ${t}`,cls:"brainstall-stat-value"});let E=g.createEl("div",{cls:"brainstall-stat-card"});E.createEl("div",{text:"\u{1F4C5} \u901A\u77E5\u3057\u305F\u65E5\u6570",cls:"brainstall-stat-label"}),E.createEl("div",{text:String(l),cls:"brainstall-stat-value"});let W=g.createEl("div",{cls:"brainstall-stat-card"});W.createEl("div",{text:"\u{1F4CA} 1\u65E5\u3042\u305F\u308A\u5E73\u5747\u6587\u5B57\u6570",cls:"brainstall-stat-label"}),W.createEl("div",{text:y,cls:"brainstall-stat-value"});let w=g.createEl("div",{cls:"brainstall-stat-card"});w.createEl("div",{text:"\u270D\uFE0F \u5408\u8A08\u6587\u5B57\u6570",cls:"brainstall-stat-label"}),w.createEl("div",{text:r.toLocaleString(),cls:"brainstall-stat-value"})}async archivePost(e,i,t=!1){var s;try{let r=(s=this.postsContainer)==null?void 0:s.querySelector(".brainstall-posts-list"),n=r?r.scrollTop:0,a=await this.app.vault.read(e);i?a.match(/^---[\s\S]*?---/)?a.includes("archived:")||a.includes("status:")?(a=a.replace(/archived:\s*(true|false)/,"archived: true"),a=a.replace(/status:\s*[^\n]+/,"status: archived")):a=a.replace(/^---([\s\S]*?)---/,(l,y)=>`---${y}
archived: true
status: archived
---`):a=`---
archived: true
status: archived
---
${a}`:(a=a.replace(/archived:\s*true/g,"archived: false"),a=a.replace(/status:\s*archived/g,"status: active")),await this.app.vault.modify(e,a),await this.updatePosts(),r&&requestAnimationFrame(()=>{r.scrollTop=n}),new h.Notice(i?"\u30A2\u30FC\u30AB\u30A4\u30D6\u3057\u307E\u3057\u305F":"\u5FA9\u5143\u3057\u307E\u3057\u305F")}catch(r){new h.Notice(`\u30A8\u30E9\u30FC: ${r}`)}}async setPriority(e,i){var t;try{let s=(t=this.postsContainer)==null?void 0:t.querySelector(".brainstall-posts-list"),r=s?s.scrollTop:0,n=await this.app.vault.read(e);n.match(/^---[\s\S]*?---/)?n.includes("priority:")?n=n.replace(/priority:\s*\d+/,`priority: ${i}`):n=n.replace(/^---([\s\S]*?)---/,(a,l)=>`---${l}
priority: ${i}
---`):n=`---
priority: ${i}
---

${n}`,await this.app.vault.modify(e,n),await this.updatePosts(),s&&requestAnimationFrame(()=>{s.scrollTop=r})}catch(s){new h.Notice(`\u30A8\u30E9\u30FC: ${s}`)}}async togglePin(e){var i;try{let t=(i=this.postsContainer)==null?void 0:i.querySelector(".brainstall-posts-list"),s=t?t.scrollTop:0,r=await this.app.vault.read(e),n=r.includes("pinned: true");r.match(/^---[\s\S]*?---/)?r.includes("pinned:")?r=r.replace(/pinned:\s*(true|false)/,`pinned: ${!n}`):r=r.replace(/^---([\s\S]*?)---/,(a,l)=>`---${l}
pinned: ${!n}
---`):r=`---
pinned: ${!n}
---
${r}`,await this.app.vault.modify(e,r),await this.updatePosts(),t&&requestAnimationFrame(()=>{t.scrollTop=s}),new h.Notice(n?"\u30D4\u30F3\u7559\u3081\u3092\u89E3\u9664\u3057\u307E\u3057\u305F":"\u30D4\u30F3\u7559\u3081\u3057\u307E\u3057\u305F")}catch(t){new h.Notice(`\u30A8\u30E9\u30FC: ${t}`)}}async deletePost(e){var i;try{let t=(i=this.postsContainer)==null?void 0:i.querySelector(".brainstall-posts-list"),s=t?t.scrollTop:0;await this.app.vault.delete(e),await this.updatePosts(),await this.updateGrass(),await this.updateStats(),t&&requestAnimationFrame(()=>{t.scrollTop=s}),new h.Notice("\u524A\u9664\u3057\u307E\u3057\u305F")}catch(t){new h.Notice(`\u30A8\u30E9\u30FC: ${t}`)}}async sharePost(e){try{let i=await this.app.vault.read(e),t=i.match(/context:\s*"([^"]+)"/),s=t?t[1]:e.basename,r=i.replace(/^---[\s\S]*?---\n?/,"").trim(),n=`[[${e.basename}]]

${r}`;if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(n),new h.Notice("\u2705 \u30AF\u30EA\u30C3\u30D7\u30DC\u30FC\u30C9\u306B\u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F");else{let a=document.createElement("textarea");a.value=n,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a),new h.Notice("\u2705 \u30AF\u30EA\u30C3\u30D7\u30DC\u30FC\u30C9\u306B\u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F")}}catch(i){new h.Notice(`\u30A8\u30E9\u30FC: ${i}`)}}async moveToTopics(e,i=!1){var t;try{let s=(t=this.postsContainer)==null?void 0:t.querySelector(".brainstall-posts-list"),r=s?s.scrollTop:0,n=this.plugin.settings.analysisFolder||"Topics";await this.app.vault.adapter.exists(n)||await this.app.vault.createFolder(n);let a=await this.app.vault.read(e),l=a.match(/context:\s*"([^"]+)"/),y=l?l[1]:"\u6DF1\u6398\u308A\u8A18\u4E8B",A=`${y.replace(/[<>:"/\\|?*]/g,"-")}.md`,E=`${n}/${A}`;if(await this.app.vault.adapter.exists(E)){let W=this.app.vault.getAbstractFileByPath(E);if(W){let w=await this.app.vault.read(W),b=a.replace(/^---[\s\S]*?---\n?/,"").trim(),D=`${w}

---

${b}`;await this.app.vault.modify(W,D),new h.Notice(`\u2705 "${y}"\u306B\u8FFD\u8A18\u3057\u307E\u3057\u305F`),await this.createTopicUpdateNotification(y,E)}}else await this.app.vault.copy(e,E),new h.Notice("\u2705 Topics\u306B\u8FFD\u52A0\u3057\u307E\u3057\u305F"),await this.createTopicNotification(y,E);await this.updatePosts(),await this.updateGrass(),await this.updateStats(),s&&requestAnimationFrame(()=>{s.scrollTop=r})}catch(s){new h.Notice(`\u30A8\u30E9\u30FC: ${s}`)}}async createTopicNotification(e,i){let t=new Date,s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),y=String(t.getSeconds()).padStart(2,"0"),g=this.plugin.settings.timestampFormat==="ISO"?t.toISOString().replace(/[:.]/g,"-").slice(0,-5):`${s}${r}${n}_${a}${l}${y}`,E=`\u65B0\u3057\u3044\u30C8\u30D4\u30C3\u30AF\u30B9[[${e}]]\u304C\u4F5C\u6210\u3055\u308C\u307E\u3057\u305F\u3002`,W=this.plugin.settings.notificationFolder||"Archives/Notifications",w=this.getDateFolderPath(W,t),b=`${g}.md`;await this.ensureFolderExists(w);let D=`${w}/${b}`;await this.app.vault.create(D,E)}async archiveFile(e){let i=await this.app.vault.read(e),t=i;i.startsWith("---")?t=i.replace(/---\n([\s\S]*?)---/,(s,r)=>r.includes("archived:")?`---
${r.replace(/archived:\s*[^\n]+/,"archived: true")}
---`:`---
${r}archived: true
---`):t=`---
archived: true
---

${i}`,await this.app.vault.modify(e,t)}async createTopicUpdateNotification(e,i){let t=new Date,s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),y=String(t.getSeconds()).padStart(2,"0"),g=this.plugin.settings.timestampFormat==="ISO"?t.toISOString().replace(/[:.]/g,"-").slice(0,-5):`${s}${r}${n}_${a}${l}${y}`,E=`\u30C8\u30D4\u30C3\u30AF\u30B9[[${e}]]\u304C\u66F4\u65B0\u3055\u308C\u307E\u3057\u305F\u3002`,W=this.plugin.settings.notificationFolder||"Archives/Notifications",w=this.getDateFolderPath(W,t),b=`${g}.md`;await this.ensureFolderExists(w);let D=`${w}/${b}`;await this.app.vault.create(D,E)}async updateReference(){this.referenceContainer.empty();let e=null;this.selectedFile!==void 0?e=this.selectedFile:e=this.app.workspace.getActiveFile();let i=this.referenceContainer.createEl("div",{cls:"brainstall-reference-header"}),t=i.createEl("div",{cls:"brainstall-reference-title-row"});t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="space-between",t.style.marginBottom="20px";let s=t.createEl("h3",{text:"\u{1F517} \u53C2\u7167"});s.style.margin="0",t.createEl("button",{text:"\u{1F504}",cls:"brainstall-refresh-btn",attr:{title:"\u66F4\u65B0"}}).addEventListener("click",async()=>{if(!this.selectedFile){let w=this.app.workspace.getActiveFile();w&&(this.selectedFile=w,this.updateActiveFileDisplay())}await this.updateReference(),new h.Notice("\u53C2\u7167\u3092\u66F4\u65B0\u3057\u307E\u3057\u305F")});let n=i.createEl("div",{cls:"brainstall-reference-file-display"});n.style.cursor="pointer",n.style.padding="8px 12px",n.style.marginBottom="20px",n.style.background="var(--background-modifier-hover)",n.style.borderRadius="6px",n.setAttribute("title","\u30AF\u30EA\u30C3\u30AF\u3057\u3066\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E"),n.style.position="relative",n.style.display="flex",n.style.alignItems="center",n.style.paddingRight="40px",n.style.overflow="hidden";let a=n.createEl("span",{cls:"brainstall-reference-file-content"});if(a.style.flex="1",a.style.minWidth="0",a.style.whiteSpace="nowrap",a.style.overflow="hidden",a.style.textOverflow="ellipsis",!e)a.textContent="\u{1F4C4} \u30D5\u30A1\u30A4\u30EB\u304C\u9078\u629E\u3055\u308C\u3066\u3044\u307E\u305B\u3093",this.referenceContainer.createEl("p",{text:"\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044",cls:"brainstall-empty"});else{a.textContent=`\u{1F4C4} ${e.basename}`;let w=n.createEl("button",{cls:"brainstall-clear-file-btn"});w.textContent="\xD7",w.setAttribute("title","\u9078\u629E\u3092\u30AF\u30EA\u30A2"),w.style.position="absolute",w.style.right="8px",w.style.top="50%",w.style.transform="translateY(-50%)",w.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),this.selectedFile=null,this.updateActiveFileDisplay(),this.updateReference()})}if(n.addEventListener("click",w=>{if(w.target.closest(".brainstall-clear-file-btn"))return;let b=this.app.vault.getMarkdownFiles();new rt(this.app,b,I=>{this.selectedFile=I,this.updateActiveFileDisplay(),this.updateReference()}).open()}),!e)return;let l=this.referenceContainer.createEl("div",{cls:"brainstall-reference-section"});l.createEl("h4",{text:"\u{1F519} \u30D0\u30C3\u30AF\u30EA\u30F3\u30AF"});let y=l.createEl("div",{cls:"brainstall-reference-list"}),g=this.referenceContainer.createEl("div",{cls:"brainstall-reference-section"});g.createEl("h4",{text:"\u{1F517} \u30D5\u30ED\u30F3\u30C8\u30EA\u30F3\u30AF"});let A=g.createEl("div",{cls:"brainstall-reference-list"}),E=this.referenceContainer.createEl("div",{cls:"brainstall-reference-section"});E.createEl("h4",{text:"\u{1F3F7}\uFE0F \u95A2\u9023\u30AD\u30FC\u30EF\u30FC\u30C9"});let W=E.createEl("div",{cls:"brainstall-reference-list"});try{let w=await this.app.vault.read(e),b=new Set,D=w.matchAll(/#[\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+/g);for(let u of D)b.add(u[0].toLowerCase());let I=this.extractWikilinks(w),B=new Set;for(let u of I){let m=u.replace(/\[\[|\]\]/g,""),f=this.app.vault.getMarkdownFiles().find(L=>L.basename===m||L.name===m);f&&f.path!==e.path&&B.add(f)}let T=this.app.vault.getMarkdownFiles(),k=new Set,v=new Map;for(let u of T)if(u.path!==e.path)try{let m=await this.app.vault.read(u),f=e.basename;m.includes(`[[${f}]]`)&&k.add(u);let L=new Set,K=m.matchAll(/#[\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+/g);for(let $ of K)L.add($[0].toLowerCase());let q=new Set;for(let $ of b)L.has($)&&q.add($);q.size>0&&v.set(u,q)}catch(m){}if(k.size===0)y.createEl("p",{text:"\u30D0\u30C3\u30AF\u30EA\u30F3\u30AF\u306F\u3042\u308A\u307E\u305B\u3093",cls:"brainstall-empty"});else for(let u of Array.from(k).sort((m,f)=>f.stat.mtime-m.stat.mtime))await this.createReferenceItem(y,u,e.path);if(B.size===0)A.createEl("p",{text:"\u30D5\u30ED\u30F3\u30C8\u30EA\u30F3\u30AF\u306F\u3042\u308A\u307E\u305B\u3093",cls:"brainstall-empty"});else for(let u of Array.from(B).sort((m,f)=>f.stat.mtime-m.stat.mtime))await this.createReferenceItem(A,u,e.path);if(v.size===0)W.createEl("p",{text:"\u95A2\u9023\u30AD\u30FC\u30EF\u30FC\u30C9\u306F\u3042\u308A\u307E\u305B\u3093",cls:"brainstall-empty"});else{let u=Array.from(v.entries()).sort((m,f)=>f[1].size-m[1].size);for(let[m,f]of u)await this.createReferenceItemWithKeywords(W,m,e.path,f)}}catch(w){console.error("Reference update error:",w),this.referenceContainer.createEl("p",{text:`\u30A8\u30E9\u30FC: ${w}`,cls:"brainstall-empty"})}}async createReferenceItem(e,i,t){let s=e.createEl("div",{cls:"brainstall-reference-item-wrapper"}),r=s.createEl("div",{cls:"brainstall-reference-item"});r.createEl("span",{text:i.basename}),await this.createReferenceItemContent(s,r,i,t)}async createReferenceItemWithKeywords(e,i,t,s){let r=e.createEl("div",{cls:"brainstall-reference-item-wrapper"}),n=r.createEl("div",{cls:"brainstall-reference-item"}),a=n.createEl("div",{cls:"brainstall-reference-keyword-content"});a.style.display="flex",a.style.flexDirection="column",a.style.flex="1",a.style.minWidth="0";let l=a.createEl("span",{text:i.basename}),y=a.createEl("span",{cls:"brainstall-reference-keywords"}),g=Array.from(s).sort();y.textContent=g.join(", "),y.style.fontSize="12px",y.style.color="var(--text-muted)",y.style.marginTop="4px",await this.createReferenceItemContent(r,n,i,t)}async createReferenceItemContent(e,i,t,s){let r=e.createEl("div",{cls:"brainstall-reference-preview hidden"}),n=!1,a=!1;i.style.cursor="pointer",i.addEventListener("click",async l=>{if(!a)try{let g=(await this.app.vault.read(t)).replace(/^---[\s\S]*?---\n?/,"").trim(),A=r.createEl("div",{cls:"brainstall-reference-preview-content"});h.MarkdownRenderer.renderMarkdown(g,A,t.path,this);let E=r.createEl("button",{cls:"brainstall-reference-open-newtab-btn",text:"\u{1F4C2} \u30BD\u30FC\u30B9\u3092\u65B0\u3057\u3044\u30BF\u30D6\u3067\u958B\u304F"});E.style.marginTop="12px",E.style.width="100%",E.addEventListener("click",W=>{W.stopPropagation(),this.app.workspace.getLeaf(!0).openFile(t)}),a=!0}catch(y){r.createEl("p",{text:`\u30A8\u30E9\u30FC: ${y}`,cls:"brainstall-empty"})}n=!n,n?(r.removeClass("hidden"),i.addClass("expanded")):(r.addClass("hidden"),i.removeClass("expanded"))})}async onClose(){this.saveListeners.forEach(e=>e()),this.saveListeners=[]}},ft=class extends h.PluginSettingTab{constructor(e,i){super(e,i);this.plugin=i}async display(){let{containerEl:e}=this;e.empty();let i=Pt;e.createEl("h3",{text:"\u{1F4C1} \u30D5\u30A9\u30EB\u30C0\u8A2D\u5B9A"}),e.createEl("p",{text:"\u5404\u30BB\u30AF\u30B7\u30E7\u30F3\u306E\u4FDD\u5B58\u5148\u30D5\u30A9\u30EB\u30C0\u3092\u8A2D\u5B9A\u3057\u307E\u3059",cls:"setting-item-description"}),new h.Setting(e).setName("\u901A\u77E5\u4FDD\u5B58\u30D5\u30A9\u30EB\u30C0").setDesc("\u901A\u77E5\u3092\u4FDD\u5B58\u3059\u308B\u30D5\u30A9\u30EB\u30C0\u306E\u30D1\u30B9").addText(t=>t.setPlaceholder("Archives/Notifications").setValue(this.plugin.settings.notificationFolder).onChange(async s=>{this.plugin.settings.notificationFolder=s,await this.plugin.saveSettings()})),new h.Setting(e).setName("\u30BF\u30A4\u30E0\u30B9\u30BF\u30F3\u30D7\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8").setDesc("\u30D5\u30A1\u30A4\u30EB\u540D\u306B\u4F7F\u7528\u3059\u308B\u30BF\u30A4\u30E0\u30B9\u30BF\u30F3\u30D7\u306E\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8").addText(t=>t.setPlaceholder("YYYYMMDD_HHmmss").setValue(this.plugin.settings.timestampFormat).onChange(async s=>{this.plugin.settings.timestampFormat=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u{1F916} AI\u8A2D\u5B9A",attr:{style:"margin-top: 30px;"}}),e.createEl("p",{text:"\u4F7F\u7528\u3059\u308BAI\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC\u3068\u30E2\u30C7\u30EB\u3092\u8A2D\u5B9A\u3057\u307E\u3059",cls:"setting-item-description"}),new h.Setting(e).setName("\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC").setDesc("\u4F7F\u7528\u3059\u308BAI\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC\u3092\u9078\u629E").addDropdown(t=>t.addOption("openai","OpenAI").addOption("claude","Claude (Anthropic)").addOption("groq","Groq").setValue(this.plugin.settings.provider).onChange(async s=>{this.plugin.settings.provider=s,await this.plugin.saveSettings(),await this.display()})),new h.Setting(e).setName("\u30E2\u30C7\u30EB").setDesc("\u4F7F\u7528\u3059\u308BAI\u30E2\u30C7\u30EB\u3092\u9078\u629E").addDropdown(t=>{let s=this.plugin.settings.provider,r=i[s]||[];r.forEach(n=>{t.addOption(n.id,n.name)}),r.length===0&&(this.plugin.settings.provider==="openai"?t.addOption("gpt-4o","gpt-4o"):this.plugin.settings.provider==="claude"?t.addOption("claude-3-5-sonnet-latest","claude-3-5-sonnet"):this.plugin.settings.provider==="groq"&&t.addOption("llama-3.3-70b-versatile","llama-3.3-70b")),t.setValue(this.plugin.settings.model).onChange(async n=>{this.plugin.settings.model=n,await this.plugin.saveSettings()})}),e.createEl("h3",{text:"\u{1F511} API Key\u8A2D\u5B9A",attr:{style:"margin-top: 30px;"}}),e.createEl("p",{text:"\u5404\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC\u306EAPI\u30AD\u30FC\u3092\u8A2D\u5B9A\u3057\u307E\u3059\uFF08\u9078\u629E\u3057\u305F\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC\u306E\u30AD\u30FC\u304C\u5FC5\u8981\u3067\u3059\uFF09",cls:"setting-item-description"}),new h.Setting(e).setName("OpenAI API Key").setDesc("OpenAI API\u306E\u30AD\u30FC").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{this.plugin.settings.openaiApiKey=s,await this.plugin.saveSettings()})}),new h.Setting(e).setName("Claude API Key").setDesc("Anthropic Claude API\u306E\u30AD\u30FC").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.claudeApiKey).onChange(async s=>{this.plugin.settings.claudeApiKey=s,await this.plugin.saveSettings()})}),new h.Setting(e).setName("Groq API Key").setDesc("Groq API\u306E\u30AD\u30FC").addText(t=>{t.inputEl.type="password",t.setPlaceholder("gsk_...").setValue(this.plugin.settings.groqApiKey).onChange(async s=>{this.plugin.settings.groqApiKey=s,await this.plugin.saveSettings()})})}},ht=class extends h.Plugin{async onload(){await this.loadSettings(),this.registerView(dt,e=>new mt(e,this)),this.addRibbonIcon("brain","Brainstall",()=>{this.openBrainstallPanel()}),this.addCommand({id:"open-brainstall",name:"Brainstall \u3092\u958B\u304F",callback:()=>{this.openBrainstallPanel()}}),this.addSettingTab(new ft(this.app,this))}async loadSettings(){this.settings=Object.assign({},At,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async openBrainstallPanel(){if(this.app.workspace.getLeavesOfType(dt).length>0)return;let i;h.Platform.isMobile?i=this.app.workspace.getLeaf(!1):i=this.app.workspace.getRightLeaf(!1),i&&(await i.setViewState({type:dt,active:!0}),this.app.workspace.revealLeaf(i))}formatTimestamp(e,i){let t=i.getFullYear(),s=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),n=String(i.getHours()).padStart(2,"0"),a=String(i.getMinutes()).padStart(2,"0"),l=String(i.getSeconds()).padStart(2,"0");return e==="ISO"?i.toISOString().replace(/[:.]/g,"-").slice(0,-5):e==="Unix"?String(Math.floor(i.getTime()/1e3)):e.replace(/YYYY/g,String(t)).replace(/MM/g,s).replace(/DD/g,r).replace(/HH/g,n).replace(/mm/g,a).replace(/ss/g,l)}toJSTISOString(e){let i=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0"),l=String(e.getMilliseconds()).padStart(3,"0");return`${i}-${t}-${s}T${r}:${n}:${a}.${l}+09:00`}getDateFolderPath(e,i){let t=i.getFullYear(),s=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),n=`${t}-${s}`,a=`${t}-${s}-${r}`;return`${e}/${t}/${n}/${a}`}async ensureFolderExists(e){if(!await this.app.vault.adapter.exists(e)){let i=e.split("/"),t="";for(let s of i)s!==""&&(t=t?`${t}/${s}`:s,await this.app.vault.adapter.exists(t)||await this.app.vault.createFolder(t))}}extractWikilinks(e){let i=/\[\[([^\]]+)\]\]/g,t=Array.from(e.matchAll(i)),s=[];for(let r of t){let n=r[1],a=n.split("|"),l=a.length>1?a[a.length-1]:n;this.app.vault.getMarkdownFiles().find(g=>g.basename===l||g.name===l)&&s.push(`[[${l}]]`)}return s}sanitizeContext(e){return e.replace(/[\/\\?%*:|"<>#\[\]]/g,"").replace(/\n+/g," ").replace(/\s+/g," ").trim()}async createNewPost(e,i=null){let t=new Date,s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),y=String(t.getSeconds()).padStart(2,"0"),g=this.formatTimestamp(this.settings.timestampFormat,t),W=(e.split(`
`)[0]||"").replace(/\[\[([^\]]+)\]\]/g,(I,B)=>{let T=B.split("|");return T.length>1?T[0]:B}).replace(/[\/\\?%*:|"<>]/g,"_").replace(/\s+/g,"_").trim(),w=`${g}_memo_${W}.md`,b=this.settings.notificationFolder||"Archives/Notifications",D=this.getDateFolderPath(b,t);try{await this.ensureFolderExists(D);let I=`${D}/${w}`,B=e.split(`
`)[0]||"",T=this.sanitizeContext(B.replace(/\[\[([^\]]+)\]\]/g,(m,f)=>{let L=f.split("|");return L.length>1?L[0]:f})),k=`---
type: memo`;T&&(k+=`
context: "${T}"`),k+=`
created: "${this.toJSTISOString(t)}"`;let v=[...this.extractWikilinks(e)];i&&this.app.vault.getMarkdownFiles().some(f=>f.path===i.path)&&v.push(`[[${i.basename}]]`);let u=Array.from(new Set(v));if(u.length>0){k+=`
links:`;for(let m of u)k+=`
  - "${m}"`}return k+=`
---

${e}`,await this.app.vault.create(I,k),I}catch(I){return new h.Notice(`\u30A8\u30E9\u30FC: ${I}`),null}}onunload(){}};
