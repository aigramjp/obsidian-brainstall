/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var gt=Object.defineProperty;var xt=Object.getOwnPropertyDescriptor;var Lt=Object.getOwnPropertyNames;var kt=Object.prototype.hasOwnProperty;var Pt=(V,Y)=>{for(var e in Y)gt(V,e,{get:Y[e],enumerable:!0})},Ft=(V,Y,e,i)=>{if(Y&&typeof Y=="object"||typeof Y=="function")for(let t of Lt(Y))!kt.call(V,t)&&t!==e&&gt(V,t,{get:()=>Y[t],enumerable:!(i=xt(Y,t))||i.enumerable});return V};var $t=V=>Ft(gt({},"__esModule",{value:!0}),V);var Mt={};Pt(Mt,{default:()=>ut});module.exports=$t(Mt);var o=require("obsidian"),dt="brainstall-view",rt=class extends o.FuzzySuggestModal{constructor(e,i,t){super(e);this.items=i,this.onChooseCallback=t}getItems(){return this.items}getItemText(e){return e.basename}onChooseItem(e,i){this.onChooseCallback(e)}},At={openai:[{id:"o1",name:"o1"},{id:"o1-preview",name:"o1-preview"},{id:"o1-mini",name:"o1-mini"},{id:"gpt-4o",name:"gpt-4o"},{id:"gpt-4o-mini",name:"gpt-4o-mini"},{id:"gpt-4.5-preview",name:"gpt-4.5-preview"},{id:"gpt-4.1",name:"gpt-4.1"},{id:"gpt-4.1-nano",name:"gpt-4.1-nano"},{id:"gpt-4.1-mini",name:"gpt-4.1-mini"},{id:"gpt-5",name:"gpt-5"},{id:"gpt-5-mini",name:"gpt-5-mini"},{id:"gpt-4-turbo",name:"gpt-4-turbo"},{id:"gpt-4",name:"gpt-4"},{id:"gpt-3.5-turbo",name:"gpt-3.5-turbo"}],groq:[{id:"qwen/qwen3-32b",name:"qwen3-32b"},{id:"llama-3.1-8b-instant",name:"llama-3.1-8b"},{id:"llama-3.3-70b-versatile",name:"llama-3.3-70b"},{id:"meta-llama/llama-4-scout-17b-16e-instruct",name:"llama-4-scout-17b"},{id:"meta-llama/llama-4-maverick-17b-128e-instruct",name:"llama-4-maverick-17b"},{id:"qwen-qwq-32b",name:"qwen-qwq-32b"}],claude:[{id:"claude-3-7-sonnet-20250219",name:"claude-3-7-sonnet"},{id:"claude-3-sonnet-20240229",name:"claude-3-sonnet"},{id:"claude-3-opus-latest",name:"claude-3-opus"},{id:"claude-3-haiku-20240307",name:"claude-3-haiku"},{id:"claude-3-5-sonnet-latest",name:"claude-3-5-sonnet"},{id:"claude-3-5-haiku-latest",name:"claude-3-5-haiku"},{id:"claude-sonnet-4-20250514",name:"claude-sonnet-4"},{id:"claude-haiku-4-5-20251001",name:"claude-haiku-4.5"},{id:"claude-opus-4-20250514",name:"claude-opus-4"},{id:"claude-opus-4-1-20250805",name:"claude-opus-4.1"}]},Dt={notificationFolder:"Archives/Notifications",provider:"openai",openaiApiKey:"",claudeApiKey:"",groqApiKey:"",model:"gpt-4o-mini",analysisFolder:"Topics",timestampFormat:"YYYYMMDD_HHmmss"},mt=class extends o.ItemView{constructor(e,i){super(e);this.plugin=i;this.showArchived=!1;this.searchKeyword="";this.searchDate="";this.searchType="";this.selectedPriorities=[];this.saveListeners=[];this.isInputVisible=!1;this.floatingButton=null;this.inputOverlay=null;this.inputResizeHandler=null;this.inputViewportHandler=null;this.activeFileDisplay=null;this.selectedFile=void 0;this.clearFileBtn=null;this.fileDisplayContent=null;this.deepDiveButton=null}getViewType(){return dt}getDisplayText(){return"Brainstall"}getIcon(){return"brain"}async onOpen(){let e=this.containerEl.children[1];e.empty(),this.notificationSectionContainer=e.createEl("div",{cls:"notification-section"}),this.inputContainer=this.notificationSectionContainer.createEl("div",{cls:"brainstall-input-section"}),this.inputContainer.addClass("hidden"),this.activeFileDisplay=this.inputContainer.createEl("div",{cls:"brainstall-active-file-display"}),this.activeFileDisplay.setAttribute("title","\u30AF\u30EA\u30C3\u30AF\u3057\u3066\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E"),this.fileDisplayContent=this.activeFileDisplay.createEl("span",{cls:"brainstall-active-file-content"}),this.clearFileBtn=this.activeFileDisplay.createEl("button",{cls:"brainstall-clear-file-btn"}),this.clearFileBtn.textContent="\xD7",this.clearFileBtn.setAttribute("title","\u9078\u629E\u3092\u30AF\u30EA\u30A2"),this.clearFileBtn.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),this.selectedFile=null,this.updateActiveFileDisplay()}),this.activeFileDisplay.addEventListener("click",f=>{if(f.target.closest(".brainstall-clear-file-btn"))return;let u=this.app.vault.getMarkdownFiles();new rt(this.app,u,h=>{this.selectedFile=h,this.updateActiveFileDisplay(),this.referenceContainer&&!this.referenceContainer.hasClass("hidden")&&this.updateReference()}).open()}),this.app.workspace.on("active-leaf-change",()=>{this.selectedFile===void 0&&(this.updateActiveFileDisplay(),this.referenceContainer&&!this.referenceContainer.hasClass("hidden")&&this.updateReference())}),this.updateActiveFileDisplay();let i=this.inputContainer.createEl("div",{cls:"brainstall-textarea-wrapper"}),t=i.createEl("textarea",{cls:"brainstall-input"});t.rows=5,t.placeholder=`\u30BF\u30A4\u30C8\u30EB
\u6982\u8981
#\u30AD\u30FC\u30EF\u30FC\u30C9`,t.setAttribute("readonly","readonly"),t.addEventListener("focus",()=>{setTimeout(()=>{t.removeAttribute("readonly")},0)}),i.createEl("button",{cls:"brainstall-input-close-btn",text:"\u2715",attr:{title:"\u9589\u3058\u308B"}}).addEventListener("click",()=>{this.toggleInputSection()});let r=this.inputContainer.createEl("div",{cls:"brainstall-input-buttons"}),a=r.createEl("button",{text:"\u{1F4DD} \u30E1\u30E2",cls:"brainstall-submit-btn"});a.disabled=!0,a.addEventListener("click",()=>{let f=t.value,u=this.selectedFile||this.app.workspace.getActiveFile();this.handleSubmitContent(f,u),t.value="",l()});let n=r.createEl("button",{text:"\u{1F4CB} \u30EA\u30B9\u30C8\u5316",cls:"brainstall-listify-btn mod-cta"});n.disabled=!0,this.deepDiveButton=r.createEl("button",{text:"\u{1F50D} \u6DF1\u6398\u308A",cls:"brainstall-deep-dive-btn mod-cta"}),this.deepDiveButton.disabled=!0;let l=()=>{let f=t.value.trim().length>0;a.disabled=!f,n.disabled=!f,this.deepDiveButton&&(this.deepDiveButton.disabled=!f)};t.addEventListener("input",l);let m="";t.addEventListener("input",f=>{var M;let u=f.target,w=u.value,h=u.selectionStart,L=w.substring(0,h),N=w.length>m.length||f.inputType==="insertText"||f.inputType==="insertCompositionText"||!f.inputType;if(L.endsWith("[[")&&N){let F=h-2,lt=u.value.substring(0,F),ot=u.value.substring(h);u.value=lt+"[[]]"+ot,u.selectionStart=F+2,u.selectionEnd=F+2;let c=this.app.vault.getMarkdownFiles(),p=!1,x=new rt(this.app,c,I=>{p=!0;let R=u.value.substring(0,F),J=u.value.substring(F+4),U=`[[${I.basename}]]`;u.value=R+U+J;let ct=F+U.length;u.selectionStart=ct,u.selectionEnd=ct,l(),u.focus()}),q=(M=x.onClose)==null?void 0:M.bind(x);q&&(x.onClose=()=>{q(),p||(u.selectionStart=F+2,u.selectionEnd=F+2,u.focus())}),x.open()}m=w}),n.addEventListener("click",async()=>{let f=t.value;if(!f.trim()){new o.Notice("\u30C6\u30AD\u30B9\u30C8\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}if(!this.checkApiKey())return;t.value="",l();let u=new o.Notice(`\u{1F4CB} \u30EA\u30B9\u30C8\u5316\u51E6\u7406\u4E2D: \u300C${f}\u300D`,0),w=`skeleton-${Date.now()}-${Math.random()}`,h=null,L=this.postsContainer.querySelector(".brainstall-posts-list");if(L||(L=this.postsContainer.createEl("div",{cls:"brainstall-posts-list"})),L){h=L.createEl("div",{cls:"brainstall-post skeleton"}),h.setAttribute("data-skeleton-id",w),h.createEl("div",{text:"\u{1F4CB} \u30EA\u30B9\u30C8\u5316\u51E6\u7406\u4E2D",cls:"brainstall-post-date"}),h.createEl("div",{text:`\u300C${f}\u300D\u306E\u30C1\u30A7\u30C3\u30AF\u30EA\u30B9\u30C8\u3092\u4F5C\u6210\u4E2D...`,cls:"brainstall-post-content"});for(let N=0;N<3;N++){let M=h.createEl("div",{cls:"brainstall-skeleton-line"});M.style.setProperty("--skeleton-width",`${80-N*10}%`),M.style.width="var(--skeleton-width)"}L.insertBefore(h,L.firstChild)}try{if(await this.handleListifyContent(f))h&&h.parentNode&&h.remove(),await this.updatePosts(),u.hide(),new o.Notice(`\u2705 \u30EA\u30B9\u30C8\u5316\u5B8C\u4E86: \u300C${f}\u300D`);else{let M=this.postsContainer.querySelector(".brainstall-posts-list"),F=M==null?void 0:M.querySelector(`[data-skeleton-id="${w}"]`);F==null||F.remove(),u.hide(),new o.Notice("\u274C \u30EA\u30B9\u30C8\u5316\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}}catch(N){let M=this.postsContainer.querySelector(".brainstall-posts-list"),F=M==null?void 0:M.querySelector(`[data-skeleton-id="${w}"]`);F==null||F.remove(),u.hide(),console.error("Listify error:",N),new o.Notice("\u274C \u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F")}}),this.deepDiveButton.addEventListener("click",async()=>{let f=t.value;if(!f.trim()){new o.Notice("\u30C6\u30AD\u30B9\u30C8\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}if(!this.checkApiKey()||!this.deepDiveButton)return;t.value="",l();let u=new o.Notice(`\u{1F50D} \u6DF1\u6398\u308A\u51E6\u7406\u4E2D: \u300C${f}\u300D`,0),w=`skeleton-${Date.now()}-${Math.random()}`,h=null,L=this.postsContainer.querySelector(".brainstall-posts-list");if(L||(L=this.postsContainer.createEl("div",{cls:"brainstall-posts-list"})),L){h=L.createEl("div",{cls:"brainstall-post skeleton"}),h.setAttribute("data-skeleton-id",w),h.createEl("div",{text:"\u{1F50D} \u6DF1\u6398\u308A\u51E6\u7406\u4E2D",cls:"brainstall-post-date"}),h.createEl("div",{text:`\u300C${f}\u300D\u306B\u95A2\u3059\u308B\u8A18\u4E8B\u3092\u4F5C\u6210\u4E2D...`,cls:"brainstall-post-content"});for(let N=0;N<3;N++){let M=h.createEl("div",{cls:"brainstall-skeleton-line"});M.style.setProperty("--skeleton-width",`${80-N*10}%`),M.style.width="var(--skeleton-width)"}L.insertBefore(h,L.firstChild)}try{let N=await this.handleDeepDiveContent(f);if(N&&N.content)h&&h.parentNode&&h.remove(),await this.saveDeepDiveArticle(f,N.title,N.content),await this.updatePosts(),u.hide(),new o.Notice(`\u2705 \u6DF1\u6398\u308A\u5B8C\u4E86: \u300C${f}\u300D`);else{let M=this.postsContainer.querySelector(".brainstall-posts-list"),F=M==null?void 0:M.querySelector(`[data-skeleton-id="${w}"]`);F==null||F.remove(),u.hide(),new o.Notice("\u274C \u6DF1\u6398\u308A\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}}catch(N){let M=this.postsContainer.querySelector(".brainstall-posts-list"),F=M==null?void 0:M.querySelector(`[data-skeleton-id="${w}"]`);F==null||F.remove(),u.hide(),console.error("DeepDive error:",N),new o.Notice("\u274C \u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F")}});let d=this.notificationSectionContainer.createEl("div",{cls:"brainstall-content"});this.contentContainer=d,this.postsContainer=d.createEl("div",{cls:"brainstall-posts active"}),this.statsContainer=d.createEl("div",{cls:"brainstall-stats hidden"}),this.grassContainer=this.statsContainer.createEl("div",{cls:"brainstall-grass"}),this.referenceContainer=d.createEl("div",{cls:"brainstall-reference hidden"});let A=this.notificationSectionContainer.createEl("div",{cls:"brainstall-tabs"}),S=A.createEl("button",{cls:"brainstall-tab active",attr:{"data-tab":"posts"}}),K=S.createEl("span",{text:"\u{1F4EC}",cls:"brainstall-tab-icon"}),v=S.createEl("span",{text:"\u53D7\u4FE1\u7BB1",cls:"brainstall-tab-label"}),y=A.createEl("button",{cls:"brainstall-tab",attr:{"data-tab":"stats"}}),P=y.createEl("span",{text:"\u{1F4CA}",cls:"brainstall-tab-icon"}),D=y.createEl("span",{text:"\u7D71\u8A08",cls:"brainstall-tab-label"}),H=A.createEl("button",{cls:"brainstall-tab",attr:{"data-tab":"reference"}}),C=H.createEl("span",{text:"\u{1F517}",cls:"brainstall-tab-icon"}),B=H.createEl("span",{text:"\u53C2\u7167",cls:"brainstall-tab-label"});S.addEventListener("click",()=>this.switchTab("posts")),y.addEventListener("click",()=>this.switchTab("stats")),H.addEventListener("click",()=>this.switchTab("reference")),this.floatingButton=e.createEl("button",{cls:"brainstall-floating-button",text:"\u270F\uFE0F",attr:{title:"\u5165\u529B\u6B04\u3092\u958B\u304F"}}),this.floatingButton.addEventListener("click",()=>{this.toggleInputSection()}),this.inputOverlay=e.createEl("div",{cls:"brainstall-input-overlay hidden"}),await this.updatePosts(),await this.updateStats()}updateActiveFileDisplay(){if(!this.fileDisplayContent)return;let e=null;this.selectedFile!==void 0?e=this.selectedFile:e=this.app.workspace.getActiveFile(),e?(this.fileDisplayContent.textContent=`\u{1F4C4} ${e.basename}`,this.clearFileBtn&&this.clearFileBtn.removeClass("hidden")):(this.fileDisplayContent.textContent="\u{1F4C4} \u30EA\u30F3\u30AF\u5143\u30D5\u30A1\u30A4\u30EB\u304C\u9078\u629E\u3055\u308C\u3066\u3044\u307E\u305B\u3093",this.clearFileBtn&&this.clearFileBtn.addClass("hidden")),this.referenceContainer&&!this.referenceContainer.hasClass("hidden")&&this.updateReference()}toggleInputSection(){var e,i;if(this.isInputVisible=!this.isInputVisible,this.isInputVisible){this.updateActiveFileDisplay();let t=(e=this.postsContainer)==null?void 0:e.querySelector(".brainstall-posts-list"),s=t?t.scrollTop:0;this.inputContainer.removeClass("hidden"),this.inputContainer.addClass("visible"),this.floatingButton&&this.floatingButton.addClass("hidden"),this.inputOverlay&&this.inputOverlay.removeClass("hidden");let r=()=>{var A;if(!this.isInputVisible||this.inputContainer.hasClass("hidden"))return;let n=this.inputContainer.getBoundingClientRect(),m=n.height+20,d=(A=this.postsContainer)==null?void 0:A.querySelector(".brainstall-posts-list");if(d){let S=d.scrollTop;d.style.setProperty("--padding-bottom",`${m}px`),d.addClass("padded"),d.scrollTop=S}if(this.inputOverlay){let S=n.top;this.inputOverlay.style.setProperty("--overlay-height",`${S}px`),this.inputOverlay.addClass("positioned")}};setTimeout(()=>{r(),t&&(t.scrollTop=s)},100);let a=this.inputContainer.querySelector("textarea");a&&(a.dispatchEvent(new Event("input",{bubbles:!0})),a.setAttribute("readonly","readonly"),setTimeout(()=>{a.focus(),setTimeout(()=>{a.removeAttribute("readonly"),t&&(t.scrollTop=s)},100)},100))}else{this.inputContainer.removeClass("visible"),this.inputContainer.addClass("hidden"),this.floatingButton&&this.floatingButton.removeClass("hidden"),this.inputOverlay&&(this.inputOverlay.addClass("hidden"),this.inputOverlay.removeClass("positioned")),this.inputResizeHandler&&(window.removeEventListener("resize",this.inputResizeHandler),this.inputResizeHandler=null),this.inputViewportHandler&&window.visualViewport&&(window.visualViewport.removeEventListener("resize",this.inputViewportHandler),window.visualViewport.removeEventListener("scroll",this.inputViewportHandler),this.inputViewportHandler=null);let t=(i=this.postsContainer)==null?void 0:i.querySelector(".brainstall-posts-list");t&&t.removeClass("padded")}}async handleSubmitContent(e,i=null){if(!e.trim()){new o.Notice("\u5185\u5BB9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}await this.plugin.createNewPost(e,i),await this.updatePosts(),await this.updateGrass(),await this.updateStats(),new o.Notice("\u901A\u77E5\u3057\u307E\u3057\u305F\uFF01"),this.toggleInputSection()}async extractWikilinkContents(e){let i=/\[\[([^\]]+)\]\]/g,t=Array.from(e.matchAll(i));if(t.length===0)return"";let s=[];for(let r of t){let a=r[1],n=a.split("|").pop()||a,l=this.app.vault.getMarkdownFiles().find(m=>m.basename===n||m.name===n);if(l)try{let m=await this.app.vault.read(l);s.push(`

## [[${n}]]\u306E\u5185\u5BB9
${m}`)}catch(m){console.error(`Failed to read file ${n}:`,m)}}return s.join(`
`)}removeWikilinksForTitle(e){return e.replace(/\[\[([^\]]+)\]\]/g,(i,t)=>{let s=t.split("|");return s.length>1?s[s.length-1]:t})}removeWikilinkBrackets(e){return e.replace(/\[\[([^\]]+)\]\]/g,(i,t)=>{let s=t.split("|");return s.length>1?s[0]:t})}extractWikilinks(e){let i=/\[\[([^\]]+)\]\]/g,t=Array.from(e.matchAll(i)),s=[];for(let r of t){let a=r[1],n=a.split("|"),l=n.length>1?n[n.length-1]:a;this.app.vault.getMarkdownFiles().find(d=>d.basename===l||d.name===l)&&s.push(`[[${l}]]`)}return s}sanitizeContext(e){return e.replace(/[\/\\?%*:|"<>#\[\]]/g,"").replace(/\n+/g," ").replace(/\s+/g," ").trim()}checkApiKey(){let e=this.plugin.settings;switch(e.provider||"openai"){case"openai":if(!e.openaiApiKey||e.openaiApiKey.trim()==="")return new o.Notice("\u26A0\uFE0F OpenAI API\u30AD\u30FC\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u304B\u3089API\u30AD\u30FC\u3092\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),!1;break;case"claude":if(!e.claudeApiKey||e.claudeApiKey.trim()==="")return new o.Notice("\u26A0\uFE0F Claude API\u30AD\u30FC\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u304B\u3089API\u30AD\u30FC\u3092\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),!1;break;case"groq":if(!e.groqApiKey||e.groqApiKey.trim()==="")return new o.Notice("\u26A0\uFE0F Groq API\u30AD\u30FC\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u304B\u3089API\u30AD\u30FC\u3092\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),!1;break}return!0}async handleListifyContent(e){let i=this.plugin.settings,t=i.provider||"openai",s=i.model||"gpt-4o-mini",r=this.selectedFile||this.app.workspace.getActiveFile(),a="",n="";r&&(n=await this.app.vault.read(r),a=r.basename.replace(/\.md$/,""));let l=await this.extractWikilinkContents(e);l&&(n+=l);let m=this.removeWikilinksForTitle(a),d=await this.callLLMForListify(e,m,n,t,s);return d&&await this.saveListifyArticle(e,m,d),d}async handleDeepDiveContent(e){let i=this.plugin.settings,t=i.provider||"openai",s=i.model||"gpt-4o-mini",r=this.selectedFile||this.app.workspace.getActiveFile(),a="",n="";r&&(n=await this.app.vault.read(r),a=r.basename.replace(/\.md$/,""));let l=await this.extractWikilinkContents(e);if(l&&(n+=l),!n||n.trim().length===0)return new o.Notice("\u274C \u53C2\u7167\u30C6\u30AD\u30B9\u30C8\u304C\u4E0D\u8DB3\u3057\u3066\u3044\u307E\u3059\u3002\u30D5\u30A1\u30A4\u30EB\u3092\u958B\u3044\u3066\u304B\u3089\u6DF1\u6398\u308A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),null;let m=this.removeWikilinksForTitle(a),d=await this.callLLMForDeepDive(e,t,s,m,n);return{title:m,content:d}}formatTimestamp(e,i){let t=i.getFullYear(),s=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),a=String(i.getHours()).padStart(2,"0"),n=String(i.getMinutes()).padStart(2,"0"),l=String(i.getSeconds()).padStart(2,"0");return e==="ISO"?i.toISOString().replace(/[:.]/g,"-").slice(0,-5):e==="Unix"?String(Math.floor(i.getTime()/1e3)):e.replace(/YYYY/g,String(t)).replace(/MM/g,s).replace(/DD/g,r).replace(/HH/g,a).replace(/mm/g,n).replace(/ss/g,l)}toJSTISOString(e){let i=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),n=String(e.getSeconds()).padStart(2,"0"),l=String(e.getMilliseconds()).padStart(3,"0");return`${i}-${t}-${s}T${r}:${a}:${n}.${l}+09:00`}getDateFolderPath(e,i){let t=i.getFullYear(),s=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),a=`${t}-${s}`,n=`${t}-${s}-${r}`;return`${e}/${t}/${a}/${n}`}async ensureFolderExists(e){if(!await this.app.vault.adapter.exists(e)){let i=e.split("/"),t="";for(let s of i)s!==""&&(t=t?`${t}/${s}`:s,await this.app.vault.adapter.exists(t)||await this.app.vault.createFolder(t))}}async saveDeepDiveArticle(e,i,t){let s=new Date,r=s.getFullYear(),a=String(s.getMonth()+1).padStart(2,"0"),n=String(s.getDate()).padStart(2,"0"),l=String(s.getHours()).padStart(2,"0"),m=String(s.getMinutes()).padStart(2,"0"),d=String(s.getSeconds()).padStart(2,"0"),A=this.formatTimestamp(this.plugin.settings.timestampFormat,s),S=e.split(`
`)[0]||"",v=this.removeWikilinkBrackets(S).replace(/[\/\\?%*:|"<>]/g,"_").replace(/\s+/g,"_").trim(),y=`${A}_deepDive_${v}.md`,P=this.plugin.settings.notificationFolder||"Archives/Notifications",D=this.getDateFolderPath(P,s);await this.ensureFolderExists(D);let H=[...this.extractWikilinks(e),...this.extractWikilinks(`[[${i}]]`)],C=Array.from(new Set(H)),B=this.sanitizeContext(this.removeWikilinkBrackets(S)),f=`---
type: deepDive`;if(B&&(f+=`
context: "${B}"`),C.length>0){f+=`
links:`;for(let w of C)f+=`
  - "${w}"`}f+=`
created: "${this.toJSTISOString(s)}"
---

${e}

---

${t}`;let u=`${D}/${y}`;await this.app.vault.create(u,f),await this.updateGrass(),await this.updateStats()}async saveListifyArticle(e,i,t){let s=new Date,r=s.getFullYear(),a=String(s.getMonth()+1).padStart(2,"0"),n=String(s.getDate()).padStart(2,"0"),l=String(s.getHours()).padStart(2,"0"),m=String(s.getMinutes()).padStart(2,"0"),d=String(s.getSeconds()).padStart(2,"0"),A=this.formatTimestamp(this.plugin.settings.timestampFormat,s),S=e.split(`
`)[0]||"",v=this.removeWikilinkBrackets(S).replace(/[\/\\?%*:|"<>]/g,"_").replace(/\s+/g,"_").trim(),y=`${A}_listify_${v}.md`,P=this.plugin.settings.notificationFolder||"Archives/Notifications",D=this.getDateFolderPath(P,s);await this.ensureFolderExists(D);let H=[...this.extractWikilinks(e),...this.extractWikilinks(`[[${i}]]`)],C=Array.from(new Set(H)),B=this.sanitizeContext(this.removeWikilinkBrackets(S)),f=`---
type: listify`;if(B&&(f+=`
context: "${B}"`),C.length>0){f+=`
links:`;for(let h of C)f+=`
  - "${h}"`}f+=`
created: "${this.toJSTISOString(s)}"
---

${e}

---

`;let u=t.map(h=>`- [ ] ${h}`).join(`
`),w=`${D}/${y}`;await this.app.vault.create(w,f+u),await this.updateGrass(),await this.updateStats()}async callLLMForListify(e,i,t,s,r){let a=this.plugin.settings;try{let n=`\u4EE5\u4E0B\u306E\u8A18\u4E8B\u300C${i}\u300D\u306E\u5185\u5BB9\u3092\u53C2\u7167\u3057\u3066\u3001\u300C${e}\u300D\u306B\u95A2\u3059\u308B\u30C1\u30A7\u30C3\u30AF\u30EA\u30B9\u30C8\u3092\u4F5C\u6210\u3057\u3066\u304F\u3060\u3055\u3044\u3002

# \u8A18\u4E8B\u5185\u5BB9
${t}

# \u8981\u6C42\u4E8B\u9805
\u4E0A\u8A18\u306E\u8A18\u4E8B\u5185\u5BB9\u3092\u3082\u3068\u306B\u3001\u300C${e}\u300D\u3068\u3044\u3046\u6587\u8108\u306B\u95A2\u9023\u3059\u308B\u884C\u52D5\u30C1\u30A7\u30C3\u30AF\u30EA\u30B9\u30C8\u3092\u4F5C\u6210\u3057\u3066\u304F\u3060\u3055\u3044\u3002  
\u76EE\u7684\u306F\u3001\u305D\u306E\u6587\u8108\u3067\u5B9F\u8DF5\u30FB\u691C\u8A0E\u30FB\u6539\u5584\u3059\u3079\u304D\u30A2\u30AF\u30B7\u30E7\u30F3\u3092\u62BD\u51FA\u3059\u308B\u3053\u3068\u3067\u3059\u3002

## \u4F5C\u6210\u30EB\u30FC\u30EB
1. \u5404\u9805\u76EE\u306F\u81EA\u7136\u306A\u65E5\u672C\u8A9E\u306E\u4E00\u6587\u3067\u66F8\u304F\u3053\u3068\u3002  
2. \u5404\u6587\u306F\u300C\u301C\u3057\u3066\u3007\u3007\u3059\u308B\u300D\u300C\u301C\u306E\u305F\u3081\u306B\u3007\u3007\u3059\u308B\u300D\u306E\u3088\u3046\u306B\u3001\u884C\u52D5\u3068\u610F\u56F3\u3092\u542B\u3081\u308B\u3053\u3068\u3002  
3. \u5404\u9805\u76EE\u306F50\u6587\u5B57\u524D\u5F8C\u3092\u76EE\u5B89\u3068\u3059\u308B\u3002  
4. \u51FA\u529B\u306F\u30C1\u30A7\u30C3\u30AF\u30EA\u30B9\u30C8\u5F62\u5F0F\uFF08- [ ]\uFF09\u306E\u307F\u3068\u3057\u3001\u4ED6\u306E\u8AAC\u660E\u3084\u898B\u51FA\u3057\u306F\u4E0D\u8981\u3002  
5. \u8A18\u53F7\u300C\uFF1A\u300D\u3084\u62EC\u5F27\u3092\u4F7F\u308F\u305A\u3001\u81EA\u7136\u306A\u6587\u7AE0\u3067\u76EE\u7684\u3092\u8868\u73FE\u3059\u308B\u3002

# \u51FA\u529B\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8\u4F8B
- [ ] \u9031\u306B\u4E00\u5EA6\u30C7\u30FC\u30BF\u3092\u30D0\u30C3\u30AF\u30A2\u30C3\u30D7\u3057\u3066\u640D\u5931\u306B\u5099\u3048\u308B  
- [ ] \u30C1\u30FC\u30E0\u3067\u9032\u6357\u3092\u5171\u6709\u3057\u3066\u8A8D\u8B58\u3092\u305D\u308D\u3048\u308B  
- [ ] \u5B9F\u9A13\u624B\u9806\u3092\u6574\u7406\u3057\u3066\u518D\u73FE\u6027\u3092\u9AD8\u3081\u308B`,l="";if(s==="openai"&&a.openaiApiKey)l=await this.callOpenAI(n,a.openaiApiKey,r);else if(s==="claude"&&a.claudeApiKey)l=await this.callClaude(n,a.claudeApiKey,r);else if(s==="groq"&&a.groqApiKey)l=await this.callGroq(n,a.groqApiKey,r);else return new o.Notice("\u274C API Key\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u753B\u9762\u3067API Key\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),null;return l.split(`
`).filter(d=>d.trim().startsWith("- [ ]")).map(d=>d.replace(/^-\s*\[\s*\]\s*/,"").trim())}catch(n){console.error("Listify Error:",n);let l=n instanceof Error?n.message:String(n);return new o.Notice(`\u274C \u30A8\u30E9\u30FC: ${l}`),null}}async callLLMForDeepDive(e,i,t,s,r){let a=this.plugin.settings;try{let n=`${e}\u3068\u3044\u3046\u6587\u8108\u3067\u4EE5\u4E0B\u306E\u53C2\u7167\u30C6\u30AD\u30B9\u30C8\u3092\u5206\u304B\u308A\u3084\u3059\u304F\u307E\u3068\u3081\u3066\u304F\u3060\u3055\u3044\u3002

\u3010\u91CD\u8981\u306A\u6307\u793A\u3011
1. \u53C2\u7167\u30C6\u30AD\u30B9\u30C8\u306F\u97F3\u58F0\u5165\u529B\u306E\u6587\u5B57\u8D77\u3053\u3057\u3067\u3042\u308B\u53EF\u80FD\u6027\u304C\u3042\u308A\u3001\u8A9E\u5C3E\u306E\u4E0D\u81EA\u7136\u3055\u3084\u9014\u4E2D\u3067\u6B62\u307E\u3063\u305F\u8868\u73FE\u3001\u9069\u5F53\u306A\u53E5\u8AAD\u70B9\u306A\u3069\u304C\u542B\u307E\u308C\u3066\u3044\u307E\u3059
2. \u5143\u306E\u6587\u7AE0\u3092\u305D\u306E\u307E\u307E\u5F15\u7528\u305B\u305A\u3001\u5185\u5BB9\u3092\u7406\u89E3\u3057\u305F\u4E0A\u3067\u66F8\u304D\u8A00\u8449\u3068\u3057\u3066\u81EA\u7136\u3067\u8AAD\u307F\u3084\u3059\u3044\u6587\u7AE0\u306B\u4FEE\u6B63\u30FB\u6574\u7406\u3057\u3066\u304F\u3060\u3055\u3044
3. \u5143\u306E\u30C6\u30AD\u30B9\u30C8\u306B\u8A18\u8F09\u3055\u308C\u3066\u3044\u306A\u3044\u60C5\u5831\u3084\u5F0F\u3001\u6570\u5F0F\u3092\u8FFD\u52A0\u3057\u306A\u3044\u3067\u304F\u3060\u3055\u3044
4. \u6587\u8108\u5916\u306E\u8A18\u53F7\u3001\u4F1A\u8A71\u3001\u95A2\u4FC2\u306E\u306A\u3044\u30E1\u30BF\u30C7\u30FC\u30BF\u306F\u8A18\u8F09\u3057\u306A\u3044\u3067\u304F\u3060\u3055\u3044
5. h1\u30BF\u30B0\u3084\u30BF\u30A4\u30C8\u30EB\u306F\u8A18\u8F09\u305B\u305A\u3001h2\u30BF\u30B0\u306E\u30B5\u30D6\u30BF\u30A4\u30C8\u30EB\u304B\u3089\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044
6. \u60C5\u5831\u3092\u30B0\u30EB\u30FC\u30D7\u5316\u3057\u3001\u8981\u70B9\u3092\u660E\u78BA\u306B\u3057\u3066\u304F\u3060\u3055\u3044
7. \u66D6\u6627\u306A\u60C5\u5831\u3084\u4E0D\u660E\u306A\u70B9\u304C\u3042\u308B\u5834\u5408\u306F\u3001\u300C\u8A73\u7D30\u306F\u4E0D\u660E\u300D\u300C\u8A18\u8F09\u306A\u3057\u300D\u3068\u660E\u8A18\u3057\u3066\u304F\u3060\u3055\u3044
8. \u8A71\u3057\u8A00\u8449\u306E\u7279\u5FB4\uFF08\u300C\u3048\u30FC\u300D\u300C\u3042\u306E\u300D\u306A\u3069\uFF09\u306F\u9664\u53BB\u3057\u3001\u66F8\u304D\u8A00\u8449\u3068\u3057\u3066\u9069\u5207\u306A\u8868\u73FE\u306B\u3057\u3066\u304F\u3060\u3055\u3044

\u51FA\u529B\u306F\u30DE\u30FC\u30AF\u30C0\u30A6\u30F3\u5F62\u5F0F\u3067\u3001\u8AAD\u307F\u3084\u3059\u304F\u6574\u7406\u3055\u308C\u305F\u8981\u7D04\u3068\u3057\u3066\u8A18\u8FF0\u3057\u3066\u304F\u3060\u3055\u3044\u3002

---
\u3010\u53C2\u7167\u30C6\u30AD\u30B9\u30C8\u3011
${r}
---`,l="";if(i==="openai"&&a.openaiApiKey)l=await this.callOpenAI(n,a.openaiApiKey,t);else if(i==="claude"&&a.claudeApiKey)l=await this.callClaude(n,a.claudeApiKey,t);else if(i==="groq"&&a.groqApiKey)l=await this.callGroq(n,a.groqApiKey,t);else return new o.Notice("\u274C API Key\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u8A2D\u5B9A\u753B\u9762\u3067API Key\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),null;return l}catch(n){console.error("DeepDive Error:",n);let l=n instanceof Error?n.message:String(n);return new o.Notice(`\u274C \u30A8\u30E9\u30FC: ${l}`),null}}async callOpenAI(e,i,t){var a;let s=await(0,o.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:t||"gpt-4o-mini",messages:[{role:"user",content:e}]})});if(s.status!==200){let n=JSON.parse(s.text||"{}");throw new Error(`OpenAI API error: ${s.status} - ${((a=n.error)==null?void 0:a.message)||"Unknown error"}`)}return JSON.parse(s.text).choices[0].message.content}async callClaude(e,i,t){var a;let s=await(0,o.requestUrl)({url:"https://api.anthropic.com/v1/messages",method:"POST",headers:{"Content-Type":"application/json","x-api-key":i,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:t||"claude-3-5-sonnet-20241022",max_tokens:1024,messages:[{role:"user",content:e}]})});if(s.status!==200){let n=JSON.parse(s.text||"{}");throw new Error(`Claude API error: ${s.status} - ${((a=n.error)==null?void 0:a.message)||"Unknown error"}`)}return JSON.parse(s.text).content[0].text}async callGroq(e,i,t){var a;let s=await(0,o.requestUrl)({url:"https://api.groq.com/openai/v1/chat/completions",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:t||"llama-3.1-70b-versatile",messages:[{role:"user",content:e}]})});if(s.status!==200){let n=JSON.parse(s.text||"{}");throw new Error(`Groq API error: ${s.status} - ${((a=n.error)==null?void 0:a.message)||"Unknown error"}`)}return JSON.parse(s.text).choices[0].message.content}getFrontmatter(e){let i=e.match(/^---\n([\s\S]*?)\n---/);if(!i)return null;let t=i[1],s={};return t.split(`
`).forEach(r=>{let a=r.match(/^(\w+):\s*(.+)$/);if(a){let n=a[1],l=a[2];(l.startsWith('"')&&l.endsWith('"')||l.startsWith("'")&&l.endsWith("'"))&&(l=l.slice(1,-1)),s[n]=l}}),s}switchTab(e){let i=this.containerEl.querySelectorAll(".brainstall-tab"),t=this.contentContainer.children;i.forEach(s=>{s.getAttribute("data-tab")===e?s.addClass("active"):s.removeClass("active")}),Array.from(t).forEach(s=>{s.hasClass("active")&&(s.removeClass("active"),s.addClass("hidden"))}),e==="posts"?(this.postsContainer.removeClass("hidden"),this.postsContainer.addClass("active")):e==="stats"?(this.statsContainer.removeClass("hidden"),this.statsContainer.addClass("active"),this.updateStats(),this.updateGrass()):e==="reference"&&(this.referenceContainer.removeClass("hidden"),this.referenceContainer.addClass("active"),this.updateReference())}async openEditorFromContent(e,i=null){let t=new Date,s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),m=String(t.getSeconds()).padStart(2,"0"),d=this.formatTimestamp(this.plugin.settings.timestampFormat,t),S=(e.split(`
`)[0]||e.slice(0,30)).slice(0,50).replace(/[\/\\?%*:|"<>]/g,"_"),K=`${d}_article_${S}.md`,v=this.plugin.settings.notificationFolder||"Archives/Notifications",y=this.getDateFolderPath(v,t);await this.ensureFolderExists(y);let P=`---
type: article
context: "${e}"
created: "${this.toJSTISOString(t)}"`;i&&(P+=`
source: "[[${i.basename}]]"`),P+=`
---

${e}`;let D=`${y}/${K}`,H=await this.app.vault.create(D,P),C=this.app.workspace.getLeaf(!0);await C.openFile(H),await new Promise(B=>setTimeout(B,100)),await C.setViewState({type:"markdown",state:{file:H.path,mode:"source"}}),new o.Notice("\u901A\u77E5\u30D5\u30A1\u30A4\u30EB\u3092\u4F5C\u6210\u3057\u307E\u3057\u305F\u3002"),await this.updatePosts(),await this.updateGrass(),await this.updateStats()}async extractHashtags(e){let i=new Set;for(let t of e)try{let r=(await this.app.vault.read(t)).matchAll(/#[\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+/g);for(let a of r)i.add(a[0].toLowerCase())}catch(s){}return Array.from(i).sort()}async updatePosts(){var lt,ot;let e=(lt=this.postsContainer)==null?void 0:lt.querySelector(".brainstall-posts-list"),i=e?e.scrollTop:0,t=this.plugin.settings.notificationFolder||"Archives/Notifications",s=this.app.vault.getFiles().filter(c=>c.path.startsWith(t+"/")),r=await Promise.all(s.map(async c=>{let p=new Date(0),x=!1;try{let q=await this.app.vault.read(c),I=this.getFrontmatter(q);if(I!=null&&I.created)p=new Date(I.created);else{let R=c.path.match(/(\d{8})_(\d{6})/);if(R){let J=R[1],U=R[2];p=new Date(parseInt(J.substring(0,4)),parseInt(J.substring(4,6))-1,parseInt(J.substring(6,8)),parseInt(U.substring(0,2)),parseInt(U.substring(2,4)),parseInt(U.substring(4,6)))}else p=new Date(c.stat.mtime)}x=q.includes("pinned: true")}catch(q){p=new Date(c.stat.mtime)}return{file:c,date:p,isPinned:x}})),a=r.sort((c,p)=>c.isPinned&&!p.isPinned?-1:!c.isPinned&&p.isPinned?1:p.date.getTime()-c.date.getTime()).map(c=>c.file),n=await this.extractHashtags(a),l=new Set;r.forEach(c=>{let p=c.date.toISOString().slice(0,10);l.add(p)});let m=Array.from(l).sort().reverse();if(this.postsContainer.empty(),a.length===0){this.postsContainer.createEl("p",{text:"\u307E\u3060\u901A\u77E5\u304C\u3042\u308A\u307E\u305B\u3093",cls:"brainstall-empty"});return}let d=this.postsContainer.createEl("div",{cls:"brainstall-posts-header"}),A=0;for(let c=0;c<a.length;c++){let p=a[c],x=await this.app.vault.read(p),q=x.includes("archived: true")||x.includes("status: archived");if(!(!this.showArchived&&q)){if(this.searchKeyword&&this.searchKeyword.startsWith("#")){let I=this.searchKeyword.toLowerCase();if(!x.toLowerCase().includes(I))continue}if(this.searchDate){let I=r.find(R=>R.file.path===p.path);if(I&&I.date.toISOString().slice(0,10)!==this.searchDate)continue}this.searchType&&!x.includes(`type: ${this.searchType}`)||A++}}let S=d.createEl("div",{cls:"brainstall-header-title-row"});S.createEl("h3",{text:`\u5168\u3066\u306E\u901A\u77E5 (${A}\u4EF6)`}),S.createEl("button",{text:"\u{1F504}",cls:"brainstall-refresh-btn",attr:{title:"\u66F4\u65B0"}}).addEventListener("click",async()=>{await this.updatePosts(),await this.updateGrass(),await this.updateStats(),new o.Notice("\u66F4\u65B0\u3057\u307E\u3057\u305F")});let v=d.createEl("div",{cls:"brainstall-header-filter-row"}),y=v.createEl("select",{cls:"brainstall-hashtag-select"});y.createEl("option",{text:"\u{1F50D} \u30CF\u30C3\u30B7\u30E5\u30BF\u30B0",value:""}),n.forEach(c=>{let p=y.createEl("option",{text:c,value:c})}),this.searchKeyword&&(y.value=this.searchKeyword),y.addEventListener("change",c=>{let p=c.target;this.searchKeyword=p.value,this.updatePosts()});let P=v.createEl("select",{cls:"brainstall-date-select"});P.createEl("option",{text:"\u{1F4C5} \u65E5\u4ED8",value:""}),m.forEach(c=>{let x=new Date(c).toLocaleDateString("ja-JP",{year:"numeric",month:"short",day:"numeric"});P.createEl("option",{text:x,value:c})}),this.searchDate&&(P.value=this.searchDate),P.addEventListener("change",c=>{let p=c.target;this.searchDate=p.value,this.updatePosts()});let D=v.createEl("select",{cls:"brainstall-type-select"});D.createEl("option",{text:"\u30BF\u30A4\u30D7",value:""}),["memo","listify","text","audio","images","deepDive"].forEach(c=>{let p={memo:"\u{1F4DD} \u30E1\u30E2",listify:"\u{1F4CB} \u30EA\u30B9\u30C8",text:"\u2328\uFE0F \u30AD\u30FC\u30DC\u30FC\u30C9\u5165\u529B",audio:"\u{1F3A4} \u30DC\u30A4\u30B9\u30E1\u30E2",images:"\u{1F4F7} \u9023\u7D9A\u64AE\u5F71",deepDive:"\u{1F50D} \u6DF1\u6398\u308A"};D.createEl("option",{text:p[c]||c,value:c})}),this.searchType&&(D.value=this.searchType),D.addEventListener("change",c=>{let p=c.target;this.searchType=p.value,this.updatePosts()});let C=v.createEl("div",{cls:"brainstall-priority-select-wrapper"}),B=C.createEl("div",{cls:"brainstall-priority-select-display"}),f=B.createEl("span",{text:this.selectedPriorities.length>0?`\u2B50 ${this.selectedPriorities.sort((c,p)=>c-p).join(", ")}`:"\u2B50 \u661F\u306E\u6570"}),u=B.createEl("span",{text:"\u25BC",cls:"brainstall-priority-select-arrow"}),w=C.createEl("div",{cls:"brainstall-priority-dropdown-list"});w.addEventListener("click",c=>{c.stopPropagation(),c.stopImmediatePropagation()},!0),w.addEventListener("mousedown",c=>{c.stopPropagation(),c.stopImmediatePropagation()},!0);for(let c=0;c<=5;c++){let p=w.createEl("label",{cls:"brainstall-priority-option-item"}),x=p.createEl("input",{type:"checkbox",cls:"brainstall-priority-option-checkbox"});x.value=c.toString(),x.checked=this.selectedPriorities.includes(c);let q=p.createEl("span",{text:"\u2B50".repeat(c)+(c===0?"\u306A\u3057":"")});c>0&&q.addClass("scaled"),x.addEventListener("click",I=>{I.stopPropagation(),I.stopImmediatePropagation()},!0),x.addEventListener("mousedown",I=>{I.stopPropagation(),I.stopImmediatePropagation()},!0),x.addEventListener("change",I=>{I.stopPropagation(),x.checked?this.selectedPriorities.includes(c)||this.selectedPriorities.push(c):this.selectedPriorities=this.selectedPriorities.filter(R=>R!==c),f.textContent=this.selectedPriorities.length>0?`\u2B50 ${this.selectedPriorities.sort((R,J)=>R-J).join(", ")}`:"\u2B50 \u661F\u306E\u6570",this.updatePosts()}),p.addEventListener("click",I=>{I.stopPropagation(),I.stopImmediatePropagation()},!0),p.addEventListener("mousedown",I=>{I.stopPropagation(),I.stopImmediatePropagation()},!0)}let h=!1,L=null;B.addEventListener("click",c=>{c.stopPropagation(),h=!h,h?(w.addClass("open"),u.textContent="\u25B2",L&&document.removeEventListener("mousedown",L),L=p=>{let x=p.target;x&&!C.contains(x)&&(h=!1,w.removeClass("open"),u.textContent="\u25BC",L&&(document.removeEventListener("mousedown",L),L=null))},setTimeout(()=>{document.addEventListener("mousedown",L,!0)},0)):(w.removeClass("open"),u.textContent="\u25BC",L&&(document.removeEventListener("mousedown",L),L=null))}),this.searchKeyword&&v.createEl("button",{text:"\u2715 \u89E3\u9664",cls:"brainstall-clear-btn",attr:{title:"\u30D5\u30A3\u30EB\u30BF\u30FC\u3092\u89E3\u9664"}}).addEventListener("click",p=>{p.stopPropagation(),this.searchKeyword="",this.updatePosts()}),v.createEl("button",{text:this.showArchived?"\u3059\u3079\u3066":"\u30A2\u30AF\u30C6\u30A3\u30D6",cls:"brainstall-filter-btn"}).addEventListener("click",()=>{this.showArchived=!this.showArchived,this.updatePosts(),this.updateStats()});let M=this.postsContainer.createEl("div",{cls:"brainstall-posts-list"});for(let c=0;c<a.length;c++){let p=a[c],x=await this.app.vault.read(p),q=this.getFrontmatter(x),I=x.includes("archived: true")||x.includes("status: archived"),R=x.includes("pinned: true"),J=x.includes("type: deepDive"),U=x.includes("type: listify"),ct="",St=x.includes("context:"),vt=x.match(/context:\s*"([^"]*)"/);if(vt&&(ct=vt[1]),!this.showArchived&&I)continue;if(this.searchKeyword&&this.searchKeyword.startsWith("#")){let g=this.searchKeyword.toLowerCase();if(!x.toLowerCase().includes(g))continue}if(this.searchDate){let g=r.find(b=>b.file.path===p.path);if(g&&g.date.toISOString().slice(0,10)!==this.searchDate)continue}if(this.searchType&&!x.includes(`type: ${this.searchType}`))continue;if(this.selectedPriorities.length>0){let g=q!=null&&q.priority?Number(q.priority):0;if(!this.selectedPriorities.includes(g))continue}let Q=M.createEl("div",{cls:"brainstall-post"}),pt=null;if(q!=null&&q.created)pt=new Date(q.created);else{let g=p.path.match(/(\d{8})_(\d{6})/);if(g){let b=g[1],E=g[2];pt=new Date(parseInt(b.substring(0,4)),parseInt(b.substring(4,6))-1,parseInt(b.substring(6,8)),parseInt(E.substring(0,2)),parseInt(E.substring(2,4)),parseInt(E.substring(4,6)))}}let yt=Q.createEl("div",{cls:"brainstall-date-priority-container"});pt&&yt.createEl("div",{text:pt.toLocaleString("ja-JP",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}),cls:"brainstall-post-date"});let Tt=q!=null&&q.priority?Number(q.priority):0,Ct=yt.createEl("div",{cls:"brainstall-priority-stars"});for(let g=1;g<=5;g++){let b=g<=Tt,E=Ct.createEl("span",{text:b?"\u2B50\uFE0F":"\u2606",cls:`brainstall-priority-star ${b?"filled":"blank"}`});E.setAttribute("data-priority",g.toString()),E.addEventListener("click",async O=>{O.stopPropagation();let T=q!=null&&q.priority?Number(q.priority):0,$=g<T?g:g===T?Math.max(0,g-1):g;await this.setPriority(p,$)})}I&&Q.addClass("archived"),R&&Q.addClass("pinned");let ht=Q.createEl("div",{cls:"brainstall-post-content"}),wt=x.replace(/^---[\s\S]*?---\n?/,"").trim().split(`
`).slice(0,3).join(`
`).trim();wt?(o.MarkdownRenderer.renderMarkdown(wt,ht,p.path,this),ht.addEventListener("click",g=>{let E=g.target.closest("a");if(E){g.preventDefault(),g.stopPropagation();let O=E.getAttribute("href"),T=E.textContent||"";if(T.startsWith("#")){let $=T.toLowerCase();this.searchKeyword=$,this.updatePosts();return}if(console.log("Link clicked:",O),O)if(O.startsWith("#search")){let $=O.substring(1);this.app.workspace.openLinkText($,p.path,!1)}else if(O.startsWith("http://")||O.startsWith("https://"))window.open(O,"_blank");else{let $=E.getAttribute("data-href");$&&this.app.workspace.openLinkText($,p.path,!1)}}})):ht.textContent="(\u7A7A)";let bt=Q.createEl("div",{cls:"brainstall-post-actions"}).createEl("div",{cls:"brainstall-right-actions"});bt.createEl("button",{text:R?"\u{1F4CC}":"\u{1F4CD}",attr:{title:R?"\u30D4\u30F3\u7559\u3081\u3092\u89E3\u9664":"\u30D4\u30F3\u7559\u3081"}}).addEventListener("click",async g=>{g.stopPropagation(),await this.togglePin(p)});let Et=bt.createEl("button",{text:"\u{1F517}"});Et.setAttribute("title","\u5171\u6709"),Et.addEventListener("click",async g=>{g.stopPropagation(),await this.sharePost(p)});let tt=Q.createEl("div",{cls:"brainstall-bottom-actions"}),et=tt.createEl("button",{text:"\u{1F5D1}\uFE0F \u524A\u9664",cls:"brainstall-bottom-action-btn"}),X=et.createEl("div",{cls:"brainstall-progress-bar"}),j=null,st=!1,G=null,Z=!1,_=null,it=!1;if(et.addEventListener("mousedown",()=>{st=!1,Z=!0,it=!1,X.style.setProperty("--progress-width","0%"),_&&(clearTimeout(_),_=null);let g=Date.now();G=window.setInterval(()=>{let b=Date.now()-g,E=Math.min(b/1e3*100,100);X.style.setProperty("--progress-width",`${E}%`)},10),j=window.setTimeout(async()=>{j=null,G&&(clearInterval(G),G=null),X.style.setProperty("--progress-width","100%"),it=!1,_=window.setTimeout(async()=>{if(_=null,it||st){X.style.setProperty("--progress-width","0%");return}st=!0,Z=!1,await this.deletePost(p),X.style.setProperty("--progress-width","0%")},50)},1e3)}),et.addEventListener("mouseup",()=>{j&&(Z=!0,clearTimeout(j),j=null),_&&(it=!0,clearTimeout(_),_=null),G&&(clearInterval(G),G=null),X.style.setProperty("--progress-width","0%")}),et.addEventListener("mouseleave",()=>{j&&(Z=!0,clearTimeout(j),j=null),_&&(it=!0,clearTimeout(_),_=null),G&&(clearInterval(G),G=null),X.style.setProperty("--progress-width","0%")}),et.addEventListener("click",async g=>{if(g.stopPropagation(),st){st=!1,Z=!1;return}if(Z){Z=!1;return}await this.deletePost(p)}),I){let g=tt.createEl("button",{text:"\u{1F4C1} \u5FA9\u5143",cls:"brainstall-bottom-action-btn"}),b=g.createEl("div",{cls:"brainstall-progress-bar"}),E=null,O=!1,T=null,$=!1,k=null,W=!1;g.addEventListener("mousedown",()=>{O=!1,$=!0,W=!1,b.style.setProperty("--progress-width","0%"),k&&(clearTimeout(k),k=null);let z=Date.now();T=window.setInterval(()=>{let at=Date.now()-z,nt=Math.min(at/1e3*100,100);b.style.setProperty("--progress-width",`${nt}%`)},10),E=window.setTimeout(async()=>{E=null,T&&(clearInterval(T),T=null),b.style.setProperty("--progress-width","100%"),W=!1,k=window.setTimeout(async()=>{if(k=null,W||O){b.style.setProperty("--progress-width","0%");return}O=!0,$=!1,await this.archivePost(p,!1,!0),b.style.setProperty("--progress-width","0%")},50)},1e3)}),g.addEventListener("mouseup",()=>{E&&($=!0,clearTimeout(E),E=null),k&&(W=!0,clearTimeout(k),k=null),T&&(clearInterval(T),T=null),b.style.setProperty("--progress-width","0%")}),g.addEventListener("mouseleave",()=>{E&&($=!0,clearTimeout(E),E=null),k&&(W=!0,clearTimeout(k),k=null),T&&(clearInterval(T),T=null),b.style.setProperty("--progress-width","0%")}),g.addEventListener("click",async z=>{if(z.stopPropagation(),O){O=!1,$=!1;return}if($){$=!1;return}await this.archivePost(p,!1,!0)})}else{let g=tt.createEl("button",{text:"\u{1F4C1} \u30A2\u30FC\u30AB\u30A4\u30D6",cls:"brainstall-bottom-action-btn"}),b=g.createEl("div",{cls:"brainstall-progress-bar"}),E=null,O=!1,T=null,$=!1,k=null,W=!1;g.addEventListener("mousedown",()=>{O=!1,$=!0,W=!1,b.style.setProperty("--progress-width","0%"),k&&(clearTimeout(k),k=null);let z=Date.now();T=window.setInterval(()=>{let at=Date.now()-z,nt=Math.min(at/1e3*100,100);b.style.setProperty("--progress-width",`${nt}%`)},10),E=window.setTimeout(async()=>{E=null,T&&(clearInterval(T),T=null),b.style.setProperty("--progress-width","100%"),W=!1,k=window.setTimeout(async()=>{if(k=null,W||O){b.style.setProperty("--progress-width","0%");return}O=!0,$=!1,await this.archivePost(p,!0,!0),b.style.setProperty("--progress-width","0%")},50)},1e3)}),g.addEventListener("mouseup",()=>{E&&($=!0,clearTimeout(E),E=null),k&&(W=!0,clearTimeout(k),k=null),T&&(clearInterval(T),T=null),b.style.setProperty("--progress-width","0%")}),g.addEventListener("mouseleave",()=>{E&&($=!0,clearTimeout(E),E=null),k&&(W=!0,clearTimeout(k),k=null),T&&(clearInterval(T),T=null),b.style.setProperty("--progress-width","0%")}),g.addEventListener("click",async z=>{if(z.stopPropagation(),O){O=!1,$=!1;return}if($){$=!1;return}await this.archivePost(p,!0,!0)})}if(St){let g=tt.createEl("button",{text:"Topics\u306B\u8FFD\u52A0",cls:"brainstall-bottom-action-btn"});g.setAttribute("title","Topics\u306B\u8FFD\u52A0");let b=g.createEl("div",{cls:"brainstall-progress-bar"}),E=null,O=!1,T=null,$=!1,k=null,W=!1;g.addEventListener("mousedown",()=>{O=!1,$=!0,W=!1,b.style.setProperty("--progress-width","0%"),k&&(clearTimeout(k),k=null);let z=Date.now();T=window.setInterval(()=>{let at=Date.now()-z,nt=Math.min(at/1e3*100,100);b.style.setProperty("--progress-width",`${nt}%`)},10),E=window.setTimeout(async()=>{E=null,T&&(clearInterval(T),T=null),b.style.setProperty("--progress-width","100%"),W=!1,k=window.setTimeout(async()=>{if(k=null,W||O){b.style.setProperty("--progress-width","0%");return}O=!0,$=!1,await this.moveToTopics(p,!0),b.style.setProperty("--progress-width","0%")},50)},1e3)}),g.addEventListener("mouseup",()=>{E&&($=!0,clearTimeout(E),E=null),k&&(W=!0,clearTimeout(k),k=null),T&&(clearInterval(T),T=null),b.style.setProperty("--progress-width","0%")}),g.addEventListener("mouseleave",()=>{E&&($=!0,clearTimeout(E),E=null),k&&(W=!0,clearTimeout(k),k=null),T&&(clearInterval(T),T=null),b.style.setProperty("--progress-width","0%")}),g.addEventListener("click",async z=>{if(z.stopPropagation(),O){O=!1,$=!1;return}if($){$=!1;return}await this.moveToTopics(p,!0)})}else tt.createEl("div");Q.addEventListener("click",g=>{let b=g.target;b.textContent&&b.textContent.startsWith("#")||b.closest("a")||this.app.workspace.openLinkText(p.path,"",!1)})}let F=(ot=this.postsContainer)==null?void 0:ot.querySelector(".brainstall-posts-list");F&&i>0&&requestAnimationFrame(()=>{F.scrollTop=i})}async updateGrass(){let e=["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"];this.grassContainer.empty();let i=await this.getPostStats(),t=Math.max(...Object.values(i),1),s=this.grassContainer.createEl("div",{cls:"brainstall-grass-grid"}),r=s.createEl("div",{cls:"brainstall-grass-row header"});r.createEl("div",{text:""});for(let l=0;l<=11;l++)r.createEl("div",{text:"",cls:"brainstall-grass-day-header"});let a=new Date,n=a.getDay();for(let l=0;l<7;l++){let m=s.createEl("div",{cls:"brainstall-grass-row"});m.createEl("div",{text:e[l],cls:"brainstall-grass-week-label"});for(let d=0;d<=11;d++){let A=11-d,S=n,v=A*7+S-l,y=new Date(a);y.setDate(y.getDate()-v);let P=`${y.getFullYear()}${String(y.getMonth()+1).padStart(2,"0")}${String(y.getDate()).padStart(2,"0")}`,D=i[P]||0,H=D>0?Math.min(.3+D/t*.7,1):0,C=m.createEl("div",{cls:"brainstall-grass-cell",attr:{title:`${y.toLocaleDateString("ja-JP")}: ${D}\u901A\u77E5`}});D>0?(C.textContent=String(D),C.style.setProperty("--cell-bg-color",`color-mix(in srgb, var(--interactive-accent) ${H*100}%, transparent)`),C.style.setProperty("--cell-text-color",H>.6?"white":"var(--text-normal)"),C.style.setProperty("--cell-opacity","1"),C.addClass("filled")):(C.style.setProperty("--cell-bg-color","var(--background-modifier-border)"),C.style.setProperty("--cell-opacity","0.3"),C.removeClass("filled"))}}}async getPostStats(){let e={},i=this.plugin.settings.notificationFolder||"Archives/Notifications";try{let t=this.app.vault.getFiles();for(let s of t)if(s.path.startsWith(i+"/")){let r=null;try{let a=await this.app.vault.read(s),n=this.getFrontmatter(a);n!=null&&n.created&&(r=new Date(n.created).toISOString().slice(0,10).replace(/-/g,""))}catch(a){let n=s.path.match(/(\d{8})\//);n&&(r=n[1])}if(!r){let a=s.path.match(/(\d{8})\//);a&&(r=a[1])}r&&(e[r]=(e[r]||0)+1)}}catch(t){console.error("Stats error:",t)}return e}async updateStats(){let e=this.plugin.settings.notificationFolder||"Archives/Notifications",i=this.app.vault.getFiles().filter(y=>y.path.startsWith(e+"/")),t=i.length,s=new Set,r=0,a=0,n=0;for(let y of i)try{let P=await this.app.vault.read(y);r+=P.length,P.includes("archived: true")||P.includes("status: archived")?n++:a++;let H=this.getFrontmatter(P),C=null;if(H!=null&&H.created&&(C=new Date(H.created).toISOString().slice(0,10).replace(/-/g,"")),!C){let B=y.path.match(/(\d{8})\//);B&&(C=B[1])}C&&s.add(C)}catch(P){}let l=s.size,m=l>0?Math.round(r/l).toLocaleString():"0";this.statsContainer.empty(),this.statsContainer.createEl("h3",{text:"\u{1F4C5} \u9032\u6357",cls:"brainstall-grass-title"}),this.grassContainer=this.statsContainer.createEl("div",{cls:"brainstall-grass"}),this.statsContainer.createEl("h3",{text:"\u{1F4CA} \u7D71\u8A08",cls:"brainstall-grass-title",attr:{style:"margin-top: 30px;"}});let d=this.statsContainer.createEl("div",{cls:"brainstall-stats-grid"}),A=d.createEl("div",{cls:"brainstall-stat-card"});A.createEl("div",{text:"\u{1F4DD} \u30A2\u30FC\u30AB\u30A4\u30D6\u6570",cls:"brainstall-stat-label"}),A.createEl("div",{text:`${n} / ${t}`,cls:"brainstall-stat-value"});let S=d.createEl("div",{cls:"brainstall-stat-card"});S.createEl("div",{text:"\u{1F4C5} \u901A\u77E5\u3057\u305F\u65E5\u6570",cls:"brainstall-stat-label"}),S.createEl("div",{text:String(l),cls:"brainstall-stat-value"});let K=d.createEl("div",{cls:"brainstall-stat-card"});K.createEl("div",{text:"\u{1F4CA} 1\u65E5\u3042\u305F\u308A\u5E73\u5747\u6587\u5B57\u6570",cls:"brainstall-stat-label"}),K.createEl("div",{text:m,cls:"brainstall-stat-value"});let v=d.createEl("div",{cls:"brainstall-stat-card"});v.createEl("div",{text:"\u270D\uFE0F \u5408\u8A08\u6587\u5B57\u6570",cls:"brainstall-stat-label"}),v.createEl("div",{text:r.toLocaleString(),cls:"brainstall-stat-value"})}async archivePost(e,i,t=!1){var s;try{let r=(s=this.postsContainer)==null?void 0:s.querySelector(".brainstall-posts-list"),a=r?r.scrollTop:0,n=await this.app.vault.read(e);i?n.match(/^---[\s\S]*?---/)?n.includes("archived:")||n.includes("status:")?(n=n.replace(/archived:\s*(true|false)/,"archived: true"),n=n.replace(/status:\s*[^\n]+/,"status: archived")):n=n.replace(/^---([\s\S]*?)---/,(l,m)=>`---${m}
archived: true
status: archived
---`):n=`---
archived: true
status: archived
---
${n}`:(n=n.replace(/archived:\s*true/g,"archived: false"),n=n.replace(/status:\s*archived/g,"status: active")),await this.app.vault.modify(e,n),await this.updatePosts(),r&&requestAnimationFrame(()=>{r.scrollTop=a}),new o.Notice(i?"\u30A2\u30FC\u30AB\u30A4\u30D6\u3057\u307E\u3057\u305F":"\u5FA9\u5143\u3057\u307E\u3057\u305F")}catch(r){new o.Notice(`\u30A8\u30E9\u30FC: ${r}`)}}async setPriority(e,i){var t;try{let s=(t=this.postsContainer)==null?void 0:t.querySelector(".brainstall-posts-list"),r=s?s.scrollTop:0,a=await this.app.vault.read(e);a.match(/^---[\s\S]*?---/)?a.includes("priority:")?a=a.replace(/priority:\s*\d+/,`priority: ${i}`):a=a.replace(/^---([\s\S]*?)---/,(n,l)=>`---${l}
priority: ${i}
---`):a=`---
priority: ${i}
---

${a}`,await this.app.vault.modify(e,a),await this.updatePosts(),s&&requestAnimationFrame(()=>{s.scrollTop=r})}catch(s){new o.Notice(`\u30A8\u30E9\u30FC: ${s}`)}}async togglePin(e){var i;try{let t=(i=this.postsContainer)==null?void 0:i.querySelector(".brainstall-posts-list"),s=t?t.scrollTop:0,r=await this.app.vault.read(e),a=r.includes("pinned: true");r.match(/^---[\s\S]*?---/)?r.includes("pinned:")?r=r.replace(/pinned:\s*(true|false)/,`pinned: ${!a}`):r=r.replace(/^---([\s\S]*?)---/,(n,l)=>`---${l}
pinned: ${!a}
---`):r=`---
pinned: ${!a}
---
${r}`,await this.app.vault.modify(e,r),await this.updatePosts(),t&&requestAnimationFrame(()=>{t.scrollTop=s}),new o.Notice(a?"\u30D4\u30F3\u7559\u3081\u3092\u89E3\u9664\u3057\u307E\u3057\u305F":"\u30D4\u30F3\u7559\u3081\u3057\u307E\u3057\u305F")}catch(t){new o.Notice(`\u30A8\u30E9\u30FC: ${t}`)}}async deletePost(e){var i;try{let t=(i=this.postsContainer)==null?void 0:i.querySelector(".brainstall-posts-list"),s=t?t.scrollTop:0;await this.app.fileManager.trashFile(e),await this.updatePosts(),await this.updateGrass(),await this.updateStats(),t&&requestAnimationFrame(()=>{t.scrollTop=s}),new o.Notice("\u524A\u9664\u3057\u307E\u3057\u305F")}catch(t){new o.Notice(`\u30A8\u30E9\u30FC: ${t}`)}}async sharePost(e){try{let i=await this.app.vault.read(e),t=i.match(/context:\s*"([^"]+)"/),s=t?t[1]:e.basename,r=i.replace(/^---[\s\S]*?---\n?/,"").trim(),a=`[[${e.basename}]]

${r}`;if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(a),new o.Notice("\u2705 \u30AF\u30EA\u30C3\u30D7\u30DC\u30FC\u30C9\u306B\u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F");else{let n=document.createElement("textarea");n.value=a,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n),new o.Notice("\u2705 \u30AF\u30EA\u30C3\u30D7\u30DC\u30FC\u30C9\u306B\u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F")}}catch(i){new o.Notice(`\u30A8\u30E9\u30FC: ${i}`)}}async moveToTopics(e,i=!1){var t;try{let s=(t=this.postsContainer)==null?void 0:t.querySelector(".brainstall-posts-list"),r=s?s.scrollTop:0,a=this.plugin.settings.analysisFolder||"Topics";await this.app.vault.adapter.exists(a)||await this.app.vault.createFolder(a);let n=await this.app.vault.read(e),l=n.match(/context:\s*"([^"]+)"/),m=l?l[1]:"\u6DF1\u6398\u308A\u8A18\u4E8B",A=`${m.replace(/[<>:"/\\|?*]/g,"-")}.md`,S=`${a}/${A}`;if(await this.app.vault.adapter.exists(S)){let K=this.app.vault.getAbstractFileByPath(S);if(K instanceof o.TFile){let v=await this.app.vault.read(K),y=n.replace(/^---[\s\S]*?---\n?/,"").trim(),P=`${v}

---

${y}`;await this.app.vault.modify(K,P),new o.Notice(`\u2705 "${m}"\u306B\u8FFD\u8A18\u3057\u307E\u3057\u305F`),await this.createTopicUpdateNotification(m,S)}}else await this.app.vault.copy(e,S),new o.Notice("\u2705 Topics\u306B\u8FFD\u52A0\u3057\u307E\u3057\u305F"),await this.createTopicNotification(m,S);await this.updatePosts(),await this.updateGrass(),await this.updateStats(),s&&requestAnimationFrame(()=>{s.scrollTop=r})}catch(s){new o.Notice(`\u30A8\u30E9\u30FC: ${s}`)}}async createTopicNotification(e,i){let t=new Date,s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),m=String(t.getSeconds()).padStart(2,"0"),d=this.plugin.settings.timestampFormat==="ISO"?t.toISOString().replace(/[:.]/g,"-").slice(0,-5):`${s}${r}${a}_${n}${l}${m}`,S=`\u65B0\u3057\u3044\u30C8\u30D4\u30C3\u30AF\u30B9[[${e}]]\u304C\u4F5C\u6210\u3055\u308C\u307E\u3057\u305F\u3002`,K=this.plugin.settings.notificationFolder||"Archives/Notifications",v=this.getDateFolderPath(K,t),y=`${d}.md`;await this.ensureFolderExists(v);let P=`${v}/${y}`;await this.app.vault.create(P,S)}async archiveFile(e){let i=await this.app.vault.read(e),t=i;i.startsWith("---")?t=i.replace(/---\n([\s\S]*?)---/,(s,r)=>r.includes("archived:")?`---
${r.replace(/archived:\s*[^\n]+/,"archived: true")}
---`:`---
${r}archived: true
---`):t=`---
archived: true
---

${i}`,await this.app.vault.modify(e,t)}async createTopicUpdateNotification(e,i){let t=new Date,s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),m=String(t.getSeconds()).padStart(2,"0"),d=this.plugin.settings.timestampFormat==="ISO"?t.toISOString().replace(/[:.]/g,"-").slice(0,-5):`${s}${r}${a}_${n}${l}${m}`,S=`\u30C8\u30D4\u30C3\u30AF\u30B9[[${e}]]\u304C\u66F4\u65B0\u3055\u308C\u307E\u3057\u305F\u3002`,K=this.plugin.settings.notificationFolder||"Archives/Notifications",v=this.getDateFolderPath(K,t),y=`${d}.md`;await this.ensureFolderExists(v);let P=`${v}/${y}`;await this.app.vault.create(P,S)}async updateReference(){this.referenceContainer.empty();let e=null;this.selectedFile!==void 0?e=this.selectedFile:e=this.app.workspace.getActiveFile();let i=this.referenceContainer.createEl("div",{cls:"brainstall-reference-header"}),t=i.createEl("div",{cls:"brainstall-reference-title-row"}),s=t.createEl("h3",{text:"\u{1F517} \u53C2\u7167"});t.createEl("button",{text:"\u{1F504}",cls:"brainstall-refresh-btn",attr:{title:"\u66F4\u65B0"}}).addEventListener("click",async()=>{if(!this.selectedFile){let v=this.app.workspace.getActiveFile();v&&(this.selectedFile=v,this.updateActiveFileDisplay())}await this.updateReference(),new o.Notice("\u53C2\u7167\u3092\u66F4\u65B0\u3057\u307E\u3057\u305F")});let a=i.createEl("div",{cls:"brainstall-reference-file-display"});a.setAttribute("title","\u30AF\u30EA\u30C3\u30AF\u3057\u3066\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E");let n=a.createEl("span",{cls:"brainstall-reference-file-content"});if(!e)n.textContent="\u{1F4C4} \u30D5\u30A1\u30A4\u30EB\u304C\u9078\u629E\u3055\u308C\u3066\u3044\u307E\u305B\u3093",this.referenceContainer.createEl("p",{text:"\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044",cls:"brainstall-empty"});else{n.textContent=`\u{1F4C4} ${e.basename}`;let v=a.createEl("button",{cls:"brainstall-clear-file-btn"});v.textContent="\xD7",v.setAttribute("title","\u9078\u629E\u3092\u30AF\u30EA\u30A2"),v.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation(),this.selectedFile=null,this.updateActiveFileDisplay(),this.updateReference()})}if(a.addEventListener("click",v=>{if(v.target.closest(".brainstall-clear-file-btn"))return;let y=this.app.vault.getMarkdownFiles();new rt(this.app,y,D=>{this.selectedFile=D,this.updateActiveFileDisplay(),this.updateReference()}).open()}),!e)return;let l=this.referenceContainer.createEl("div",{cls:"brainstall-reference-section"});l.createEl("h4",{text:"\u{1F519} \u30D0\u30C3\u30AF\u30EA\u30F3\u30AF"});let m=l.createEl("div",{cls:"brainstall-reference-list"}),d=this.referenceContainer.createEl("div",{cls:"brainstall-reference-section"});d.createEl("h4",{text:"\u{1F517} \u30D5\u30ED\u30F3\u30C8\u30EA\u30F3\u30AF"});let A=d.createEl("div",{cls:"brainstall-reference-list"}),S=this.referenceContainer.createEl("div",{cls:"brainstall-reference-section"});S.createEl("h4",{text:"\u{1F3F7}\uFE0F \u95A2\u9023\u30AD\u30FC\u30EF\u30FC\u30C9"});let K=S.createEl("div",{cls:"brainstall-reference-list"});try{let v=await this.app.vault.read(e),y=new Set,P=v.matchAll(/#[\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+/g);for(let u of P)y.add(u[0].toLowerCase());let D=this.extractWikilinks(v),H=new Set;for(let u of D){let w=u.replace(/\[\[|\]\]/g,""),h=this.app.vault.getMarkdownFiles().find(L=>L.basename===w||L.name===w);h&&h.path!==e.path&&H.add(h)}let C=this.app.vault.getMarkdownFiles(),B=new Set,f=new Map;for(let u of C)if(u.path!==e.path)try{let w=await this.app.vault.read(u),h=e.basename;w.includes(`[[${h}]]`)&&B.add(u);let L=new Set,N=w.matchAll(/#[\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+/g);for(let F of N)L.add(F[0].toLowerCase());let M=new Set;for(let F of y)L.has(F)&&M.add(F);M.size>0&&f.set(u,M)}catch(w){}if(B.size===0)m.createEl("p",{text:"\u30D0\u30C3\u30AF\u30EA\u30F3\u30AF\u306F\u3042\u308A\u307E\u305B\u3093",cls:"brainstall-empty"});else for(let u of Array.from(B).sort((w,h)=>h.stat.mtime-w.stat.mtime))await this.createReferenceItem(m,u,e.path);if(H.size===0)A.createEl("p",{text:"\u30D5\u30ED\u30F3\u30C8\u30EA\u30F3\u30AF\u306F\u3042\u308A\u307E\u305B\u3093",cls:"brainstall-empty"});else for(let u of Array.from(H).sort((w,h)=>h.stat.mtime-w.stat.mtime))await this.createReferenceItem(A,u,e.path);if(f.size===0)K.createEl("p",{text:"\u95A2\u9023\u30AD\u30FC\u30EF\u30FC\u30C9\u306F\u3042\u308A\u307E\u305B\u3093",cls:"brainstall-empty"});else{let u=Array.from(f.entries()).sort((w,h)=>h[1].size-w[1].size);for(let[w,h]of u)await this.createReferenceItemWithKeywords(K,w,e.path,h)}}catch(v){console.error("Reference update error:",v),this.referenceContainer.createEl("p",{text:`\u30A8\u30E9\u30FC: ${v}`,cls:"brainstall-empty"})}}async createReferenceItem(e,i,t){let s=e.createEl("div",{cls:"brainstall-reference-item-wrapper"}),r=s.createEl("div",{cls:"brainstall-reference-item"});r.createEl("span",{text:i.basename}),await this.createReferenceItemContent(s,r,i,t)}async createReferenceItemWithKeywords(e,i,t,s){let r=e.createEl("div",{cls:"brainstall-reference-item-wrapper"}),a=r.createEl("div",{cls:"brainstall-reference-item"}),n=a.createEl("div",{cls:"brainstall-reference-keyword-content"}),l=n.createEl("span",{text:i.basename}),m=n.createEl("span",{cls:"brainstall-reference-keywords"}),d=Array.from(s).sort();m.textContent=d.join(", "),await this.createReferenceItemContent(r,a,i,t)}async createReferenceItemContent(e,i,t,s){let r=e.createEl("div",{cls:"brainstall-reference-preview hidden"}),a=!1,n=!1;i.addEventListener("click",async l=>{if(!n)try{let d=(await this.app.vault.read(t)).replace(/^---[\s\S]*?---\n?/,"").trim(),A=r.createEl("div",{cls:"brainstall-reference-preview-content"});o.MarkdownRenderer.renderMarkdown(d,A,t.path,this),r.createEl("button",{cls:"brainstall-reference-open-newtab-btn",text:"\u{1F4C2} \u30BD\u30FC\u30B9\u3092\u65B0\u3057\u3044\u30BF\u30D6\u3067\u958B\u304F"}).addEventListener("click",K=>{K.stopPropagation(),this.app.workspace.getLeaf(!0).openFile(t)}),n=!0}catch(m){r.createEl("p",{text:`\u30A8\u30E9\u30FC: ${m}`,cls:"brainstall-empty"})}a=!a,a?(r.removeClass("hidden"),i.addClass("expanded")):(r.addClass("hidden"),i.removeClass("expanded"))})}async onClose(){this.saveListeners.forEach(e=>e()),this.saveListeners=[]}},ft=class extends o.PluginSettingTab{constructor(e,i){super(e,i);this.plugin=i}async display(){let{containerEl:e}=this;e.empty();let i=At;e.createEl("h3",{text:"\u{1F4C1} \u30D5\u30A9\u30EB\u30C0\u8A2D\u5B9A"}),e.createEl("p",{text:"\u5404\u30BB\u30AF\u30B7\u30E7\u30F3\u306E\u4FDD\u5B58\u5148\u30D5\u30A9\u30EB\u30C0\u3092\u8A2D\u5B9A\u3057\u307E\u3059",cls:"setting-item-description"}),new o.Setting(e).setName("\u901A\u77E5\u4FDD\u5B58\u30D5\u30A9\u30EB\u30C0").setDesc("\u901A\u77E5\u3092\u4FDD\u5B58\u3059\u308B\u30D5\u30A9\u30EB\u30C0\u306E\u30D1\u30B9").addText(t=>t.setPlaceholder("Archives/Notifications").setValue(this.plugin.settings.notificationFolder).onChange(async s=>{this.plugin.settings.notificationFolder=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("\u30BF\u30A4\u30E0\u30B9\u30BF\u30F3\u30D7\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8").setDesc("\u30D5\u30A1\u30A4\u30EB\u540D\u306B\u4F7F\u7528\u3059\u308B\u30BF\u30A4\u30E0\u30B9\u30BF\u30F3\u30D7\u306E\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8").addText(t=>t.setPlaceholder("YYYYMMDD_HHmmss").setValue(this.plugin.settings.timestampFormat).onChange(async s=>{this.plugin.settings.timestampFormat=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u{1F916} AI\u8A2D\u5B9A",attr:{style:"margin-top: 30px;"}}),e.createEl("p",{text:"\u4F7F\u7528\u3059\u308BAI\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC\u3068\u30E2\u30C7\u30EB\u3092\u8A2D\u5B9A\u3057\u307E\u3059",cls:"setting-item-description"}),new o.Setting(e).setName("\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC").setDesc("\u4F7F\u7528\u3059\u308BAI\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC\u3092\u9078\u629E").addDropdown(t=>t.addOption("openai","OpenAI").addOption("claude","Claude (Anthropic)").addOption("groq","Groq").setValue(this.plugin.settings.provider).onChange(async s=>{this.plugin.settings.provider=s,await this.plugin.saveSettings(),await this.display()})),new o.Setting(e).setName("\u30E2\u30C7\u30EB").setDesc("\u4F7F\u7528\u3059\u308BAI\u30E2\u30C7\u30EB\u3092\u9078\u629E").addDropdown(t=>{let s=this.plugin.settings.provider,r=i[s]||[];r.forEach(a=>{t.addOption(a.id,a.name)}),r.length===0&&(this.plugin.settings.provider==="openai"?t.addOption("gpt-4o","gpt-4o"):this.plugin.settings.provider==="claude"?t.addOption("claude-3-5-sonnet-latest","claude-3-5-sonnet"):this.plugin.settings.provider==="groq"&&t.addOption("llama-3.3-70b-versatile","llama-3.3-70b")),t.setValue(this.plugin.settings.model).onChange(async a=>{this.plugin.settings.model=a,await this.plugin.saveSettings()})}),e.createEl("h3",{text:"\u{1F511} API Key\u8A2D\u5B9A",attr:{style:"margin-top: 30px;"}}),e.createEl("p",{text:"\u5404\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC\u306EAPI\u30AD\u30FC\u3092\u8A2D\u5B9A\u3057\u307E\u3059\uFF08\u9078\u629E\u3057\u305F\u30D7\u30ED\u30D0\u30A4\u30C0\u30FC\u306E\u30AD\u30FC\u304C\u5FC5\u8981\u3067\u3059\uFF09",cls:"setting-item-description"}),new o.Setting(e).setName("OpenAI API Key").setDesc("OpenAI API\u306E\u30AD\u30FC").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{this.plugin.settings.openaiApiKey=s,await this.plugin.saveSettings()})}),new o.Setting(e).setName("Claude API Key").setDesc("Anthropic Claude API\u306E\u30AD\u30FC").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.claudeApiKey).onChange(async s=>{this.plugin.settings.claudeApiKey=s,await this.plugin.saveSettings()})}),new o.Setting(e).setName("Groq API Key").setDesc("Groq API\u306E\u30AD\u30FC").addText(t=>{t.inputEl.type="password",t.setPlaceholder("gsk_...").setValue(this.plugin.settings.groqApiKey).onChange(async s=>{this.plugin.settings.groqApiKey=s,await this.plugin.saveSettings()})})}},ut=class extends o.Plugin{async onload(){await this.loadSettings(),this.registerView(dt,e=>new mt(e,this)),this.addRibbonIcon("brain","Brainstall",()=>{this.openBrainstallPanel()}),this.addCommand({id:"open-view",name:"\u30E1\u30A4\u30F3\u30D3\u30E5\u30FC\u3092\u958B\u304F",callback:()=>{this.openBrainstallPanel()}}),this.addSettingTab(new ft(this.app,this))}async loadSettings(){this.settings=Object.assign({},Dt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async openBrainstallPanel(){if(this.app.workspace.getLeavesOfType(dt).length>0)return;let i;o.Platform.isMobile?i=this.app.workspace.getLeaf(!1):i=this.app.workspace.getRightLeaf(!1),i&&(await i.setViewState({type:dt,active:!0}),this.app.workspace.revealLeaf(i))}formatTimestamp(e,i){let t=i.getFullYear(),s=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),a=String(i.getHours()).padStart(2,"0"),n=String(i.getMinutes()).padStart(2,"0"),l=String(i.getSeconds()).padStart(2,"0");return e==="ISO"?i.toISOString().replace(/[:.]/g,"-").slice(0,-5):e==="Unix"?String(Math.floor(i.getTime()/1e3)):e.replace(/YYYY/g,String(t)).replace(/MM/g,s).replace(/DD/g,r).replace(/HH/g,a).replace(/mm/g,n).replace(/ss/g,l)}toJSTISOString(e){let i=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),n=String(e.getSeconds()).padStart(2,"0"),l=String(e.getMilliseconds()).padStart(3,"0");return`${i}-${t}-${s}T${r}:${a}:${n}.${l}+09:00`}getDateFolderPath(e,i){let t=i.getFullYear(),s=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),a=`${t}-${s}`,n=`${t}-${s}-${r}`;return`${e}/${t}/${a}/${n}`}async ensureFolderExists(e){if(!await this.app.vault.adapter.exists(e)){let i=e.split("/"),t="";for(let s of i)s!==""&&(t=t?`${t}/${s}`:s,await this.app.vault.adapter.exists(t)||await this.app.vault.createFolder(t))}}extractWikilinks(e){let i=/\[\[([^\]]+)\]\]/g,t=Array.from(e.matchAll(i)),s=[];for(let r of t){let a=r[1],n=a.split("|"),l=n.length>1?n[n.length-1]:a;this.app.vault.getMarkdownFiles().find(d=>d.basename===l||d.name===l)&&s.push(`[[${l}]]`)}return s}sanitizeContext(e){return e.replace(/[\/\\?%*:|"<>#\[\]]/g,"").replace(/\n+/g," ").replace(/\s+/g," ").trim()}async createNewPost(e,i=null){let t=new Date,s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),m=String(t.getSeconds()).padStart(2,"0"),d=this.formatTimestamp(this.settings.timestampFormat,t),K=(e.split(`
`)[0]||"").replace(/\[\[([^\]]+)\]\]/g,(D,H)=>{let C=H.split("|");return C.length>1?C[0]:H}).replace(/[\/\\?%*:|"<>]/g,"_").replace(/\s+/g,"_").trim(),v=`${d}_memo_${K}.md`,y=this.settings.notificationFolder||"Archives/Notifications",P=this.getDateFolderPath(y,t);try{await this.ensureFolderExists(P);let D=`${P}/${v}`,H=e.split(`
`)[0]||"",C=this.sanitizeContext(H.replace(/\[\[([^\]]+)\]\]/g,(w,h)=>{let L=h.split("|");return L.length>1?L[0]:h})),B=`---
type: memo`;C&&(B+=`
context: "${C}"`),B+=`
created: "${this.toJSTISOString(t)}"`;let f=[...this.extractWikilinks(e)];i&&this.app.vault.getMarkdownFiles().some(h=>h.path===i.path)&&f.push(`[[${i.basename}]]`);let u=Array.from(new Set(f));if(u.length>0){B+=`
links:`;for(let w of u)B+=`
  - "${w}"`}return B+=`
---

${e}`,await this.app.vault.create(D,B),D}catch(D){return new o.Notice(`\u30A8\u30E9\u30FC: ${D}`),null}}onunload(){}};
